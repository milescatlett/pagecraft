<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page.title }} - {{ site.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .preview-banner {
            background: #0d6efd;
            color: white;
            padding: 0.5rem 0;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1050;
        }

        .menu-left, .menu-right {
            width: 250px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 1rem;
        }

        .menu-left {
            border-right: none;
        }

        .menu-right {
            border-left: none;
        }

        .menu-top {
            background: #f8f9fa;
        }

        .page-with-sidebar {
            display: flex;
            min-height: calc(100vh - 100px);
        }

        .page-content-wrapper {
            flex: 1;
            padding: 2rem;
        }

        footer {
            background: #343a40;
            color: white;
            padding: 2rem 0;
            margin-top: auto;
        }

        footer a {
            color: #adb5bd;
            text-decoration: none;
        }

        footer a:hover {
            color: white;
        }

        /* Nested dropdown styles */
        .dropdown-menu .dropend > .dropdown-toggle::after {
            display: inline-block;
            margin-left: 0.5em;
            vertical-align: 0.255em;
            content: "";
            border-top: 0.3em solid transparent;
            border-right: 0;
            border-bottom: 0.3em solid transparent;
            border-left: 0.3em solid;
        }

        .dropdown-menu .dropend > .dropdown-menu {
            top: 0;
            left: 100%;
            margin-top: 0;
            margin-left: 0.125rem;
        }

        .dropdown-menu .dropend:hover > .dropdown-menu {
            display: block;
        }

        .dropdown-menu .dropend > .dropdown-toggle:hover {
            background-color: #e9ecef;
        }

        /* Dynamic menu link colors */
        {% if top_menu_styles and top_menu_styles.linkColor %}
        .menu-top a, .menu-top .nav-link {
            color: {{ top_menu_styles.linkColor }} !important;
        }
        {% endif %}
        {% if top_menu_styles and top_menu_styles.dropdownLinkColor %}
        .menu-top .dropdown-item {
            color: {{ top_menu_styles.dropdownLinkColor }} !important;
        }
        {% endif %}

        {% if left_menu_styles and left_menu_styles.linkColor %}
        .menu-left a, .menu-left .nav-link {
            color: {{ left_menu_styles.linkColor }} !important;
        }
        {% endif %}
        {% if left_menu_styles and left_menu_styles.dropdownLinkColor %}
        .menu-left .dropdown-item {
            color: {{ left_menu_styles.dropdownLinkColor }} !important;
        }
        {% endif %}

        {% if right_menu_styles and right_menu_styles.linkColor %}
        .menu-right a, .menu-right .nav-link {
            color: {{ right_menu_styles.linkColor }} !important;
        }
        {% endif %}
        {% if right_menu_styles and right_menu_styles.dropdownLinkColor %}
        .menu-right .dropdown-item {
            color: {{ right_menu_styles.dropdownLinkColor }} !important;
        }
        {% endif %}

        /* Dynamic footer styles */
        {% if footer_styles %}
        {% if footer_styles.backgroundColor or footer_styles.color or footer_styles.padding %}
        footer {
            {% if footer_styles.backgroundColor %}background-color: {{ footer_styles.backgroundColor }};{% endif %}
            {% if footer_styles.color %}color: {{ footer_styles.color }};{% endif %}
            {% if footer_styles.padding %}padding: {{ footer_styles.padding }};{% endif %}
            {% if footer_styles.margin %}margin: {{ footer_styles.margin }};{% endif %}
            {% if footer_styles.borderTop %}border-top: {{ footer_styles.borderTop }};{% endif %}
            {% if footer_styles.borderBottom %}border-bottom: {{ footer_styles.borderBottom }};{% endif %}
            {% if footer_styles.backgroundImage %}background-image: url('{{ footer_styles.backgroundImage }}'); background-repeat: no-repeat;{% endif %}
            {% if footer_styles.backgroundSize %}background-size: {{ footer_styles.backgroundSize }};{% endif %}
        }
        {% endif %}

        {% if footer_styles.linkColor %}
        footer a {
            color: {{ footer_styles.linkColor }} !important;
        }
        footer a:hover {
            color: {{ footer_styles.linkColor }} !important;
            filter: brightness(1.2);
        }
        {% endif %}
        {% endif %}
    </style>
</head>
<body{% if page_styles and page_styles is mapping %} style="{% if page_styles.get('backgroundColor') %}background-color: {{ page_styles.get('backgroundColor') }}; {% endif %}{% if page_styles.get('color') %}color: {{ page_styles.get('color') }}; {% endif %}{% if page_styles.get('textDecoration') %}text-decoration: {{ page_styles.get('textDecoration') }}; {% endif %}{% if page_styles.get('fontWeight') %}font-weight: {{ page_styles.get('fontWeight') }}; {% endif %}{% if page_styles.get('fontStyle') %}font-style: {{ page_styles.get('fontStyle') }}; {% endif %}{% if page_styles.get('backgroundImage') %}background-image: url('{{ page_styles.get('backgroundImage') }}'); background-repeat: no-repeat; {% endif %}{% if page_styles.get('backgroundSize') %}background-size: {{ page_styles.get('backgroundSize') }}; {% endif %}{% if page_styles.get('backgroundPosition') %}background-position: {{ page_styles.get('backgroundPosition') }}; {% endif %}{% if page_styles.get('custom') %}{{ page_styles.get('custom') }}; {% endif %}"{% endif %}>
    {% macro build_style_attr(widget) %}{% set styles = widget.get('styles', {}) %}{% if styles %}style="{% if styles.get('display') %}display: {{ styles.get('display') }}; {% endif %}{% if styles.get('textAlign') %}text-align: {{ styles.get('textAlign') }}; {% endif %}{% if styles.get('alignItems') %}align-items: {{ styles.get('alignItems') }}; {% endif %}{% if styles.get('color') %}color: {{ styles.get('color') }}; {% endif %}{% if styles.get('backgroundColor') %}background-color: {{ styles.get('backgroundColor') }}; {% endif %}{% if styles.get('textDecoration') %}text-decoration: {{ styles.get('textDecoration') }}; {% endif %}{% if styles.get('fontWeight') %}font-weight: {{ styles.get('fontWeight') }}; {% endif %}{% if styles.get('fontStyle') %}font-style: {{ styles.get('fontStyle') }}; {% endif %}{% if styles.get('backgroundImage') %}background-image: url('{{ styles.get('backgroundImage') }}'); background-repeat: no-repeat; {% endif %}{% if styles.get('backgroundSize') %}background-size: {{ styles.get('backgroundSize') }}; {% endif %}{% if styles.get('backgroundPosition') %}background-position: {{ styles.get('backgroundPosition') }}; {% endif %}{% if styles.get('borderTop') %}border-top: {{ styles.get('borderTop') }}; {% endif %}{% if styles.get('borderRight') %}border-right: {{ styles.get('borderRight') }}; {% endif %}{% if styles.get('borderBottom') %}border-bottom: {{ styles.get('borderBottom') }}; {% endif %}{% if styles.get('borderLeft') %}border-left: {{ styles.get('borderLeft') }}; {% endif %}{% if styles.get('borderRadius') %}border-radius: {{ styles.get('borderRadius') }}; {% endif %}{% if styles.get('boxShadow') %}box-shadow: {{ styles.get('boxShadow') }}; {% endif %}{% if styles.get('padding') %}padding: {{ styles.get('padding') }}; {% endif %}{% if styles.get('margin') %}margin: {{ styles.get('margin') }}; {% endif %}{% if styles.get('width') %}width: {{ styles.get('width') }}; {% endif %}{% if styles.get('height') %}height: {{ styles.get('height') }}; {% endif %}{% if styles.get('custom') %}{{ styles.get('custom') }}; {% endif %}"{% endif %}{% endmacro %}

    {% macro build_anchor_style_attr(widget) %}{% set styles = widget.get('styles', {}) %}{% if styles and (styles.get('display') or styles.get('color') or styles.get('textDecoration') or styles.get('fontWeight') or styles.get('fontStyle')) %}style="{% if styles.get('display') %}display: {{ styles.get('display') }}; {% endif %}{% if styles.get('color') %}color: {{ styles.get('color') }}; {% endif %}{% if styles.get('textDecoration') %}text-decoration: {{ styles.get('textDecoration') }}; {% endif %}{% if styles.get('fontWeight') %}font-weight: {{ styles.get('fontWeight') }}; {% endif %}{% if styles.get('fontStyle') %}font-style: {{ styles.get('fontStyle') }}; {% endif %}"{% endif %}{% endmacro %}

    {% macro build_container_style_attr(widget) %}{% set styles = widget.get('styles', {}) %}{% if styles %}style="{% if styles.get('display') %}display: {{ styles.get('display') }}; {% endif %}{% if styles.get('textAlign') %}text-align: {{ styles.get('textAlign') }}; {% endif %}{% if styles.get('alignItems') %}align-items: {{ styles.get('alignItems') }}; {% endif %}{% if styles.get('backgroundColor') %}background-color: {{ styles.get('backgroundColor') }}; {% endif %}{% if styles.get('backgroundImage') %}background-image: url('{{ styles.get('backgroundImage') }}'); background-repeat: no-repeat; {% endif %}{% if styles.get('backgroundSize') %}background-size: {{ styles.get('backgroundSize') }}; {% endif %}{% if styles.get('backgroundPosition') %}background-position: {{ styles.get('backgroundPosition') }}; {% endif %}{% if styles.get('borderTop') %}border-top: {{ styles.get('borderTop') }}; {% endif %}{% if styles.get('borderRight') %}border-right: {{ styles.get('borderRight') }}; {% endif %}{% if styles.get('borderBottom') %}border-bottom: {{ styles.get('borderBottom') }}; {% endif %}{% if styles.get('borderLeft') %}border-left: {{ styles.get('borderLeft') }}; {% endif %}{% if styles.get('borderRadius') %}border-radius: {{ styles.get('borderRadius') }}; {% endif %}{% if styles.get('boxShadow') %}box-shadow: {{ styles.get('boxShadow') }}; {% endif %}{% if styles.get('padding') %}padding: {{ styles.get('padding') }}; {% endif %}{% if styles.get('margin') %}margin: {{ styles.get('margin') }}; {% endif %}{% if styles.get('width') %}width: {{ styles.get('width') }}; {% endif %}{% if styles.get('height') %}height: {{ styles.get('height') }}; {% endif %}{% if styles.get('custom') %}{{ styles.get('custom') }}; {% endif %}"{% endif %}{% endmacro %}

    {% macro render_widget(widget) %}
        {% if widget.type == 'row' %}
            <div class="mb-4">
                <div {{ build_style_attr(widget) }}>
                    {% if widget.children %}
                        <div class="row">
                            {% for child in widget.children %}
                                {{ render_widget(child) }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

        {% elif widget.type == 'column' %}
            <div class="col-{{ widget.width|default(6) }}">
                <div {{ build_style_attr(widget) }}>
                    {% if widget.children %}
                        {% for child in widget.children %}
                            {{ render_widget(child) }}
                        {% endfor %}
                    {% endif %}
                </div>
            </div>

        {% elif widget.type == 'heading' %}
            <{{ widget.level|default('h2') }} {{ build_style_attr(widget) }}>{{ widget.content }}</{{ widget.level|default('h2') }}>

        {% elif widget.type == 'richtext' %}
            <div class="mb-3" {{ build_style_attr(widget) }}>{{ widget.content|safe }}</div>

        {% elif widget.type == 'html' %}
            <div {{ build_style_attr(widget) }}>{{ widget.content|safe }}</div>

        {% elif widget.type == 'separator' %}
            <hr class="my-4" {{ build_style_attr(widget) }}>

        {% elif widget.type == 'button' %}
            {% if widget.dropdownItems and widget.dropdownItems|length > 0 %}
                {# Button with dropdown menu #}
                <div class="btn-group mb-3" {{ build_container_style_attr(widget) }}>
                    <button type="button" class="btn btn-{{ widget.style }} dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        {{ widget.text }}
                    </button>
                    <ul class="dropdown-menu">
                        {% for item in widget.dropdownItems %}
                            {% if item.nestedItems and item.nestedItems|length > 0 %}
                                {# 2nd tier with nested 3rd tier items #}
                                <li class="dropend">
                                    <a class="dropdown-item dropdown-toggle" href="{{ item.url }}">{{ item.text }}</a>
                                    <ul class="dropdown-menu">
                                        {% for nested in item.nestedItems %}
                                            <li><a class="dropdown-item" href="{{ nested.url }}">{{ nested.text }}</a></li>
                                        {% endfor %}
                                    </ul>
                                </li>
                            {% else %}
                                {# Simple 2nd tier item #}
                                <li><a class="dropdown-item" href="{{ item.url }}">{{ item.text }}</a></li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
            {% else %}
                {# Simple button without dropdown #}
                <a href="{{ widget.url }}" class="btn btn-{{ widget.style }} mb-3" {{ build_style_attr(widget) }}>{{ widget.text }}</a>
            {% endif %}

        {% elif widget.type == 'link' %}
            {% if widget.dropdownItems and widget.dropdownItems|length > 0 %}
                {# Dropdown link widget with dropdownItems structure #}
                <div class="dropdown mb-3" {{ build_container_style_attr(widget) }}>
                    <a class="dropdown-toggle" href="{{ widget.url }}" data-bs-toggle="dropdown" aria-expanded="false" {{ build_anchor_style_attr(widget) }}>{{ widget.text }}</a>
                    <ul class="dropdown-menu">
                        {% for item in widget.dropdownItems %}
                            {% if item.nestedItems and item.nestedItems|length > 0 %}
                                {# 2nd tier with nested 3rd tier items #}
                                <li class="dropend">
                                    <a class="dropdown-item dropdown-toggle" href="{{ item.url }}">{{ item.text }}</a>
                                    <ul class="dropdown-menu">
                                        {% for nested in item.nestedItems %}
                                            <li><a class="dropdown-item" href="{{ nested.url }}">{{ nested.text }}</a></li>
                                        {% endfor %}
                                    </ul>
                                </li>
                            {% else %}
                                {# Simple 2nd tier item #}
                                <li><a class="dropdown-item" href="{{ item.url }}">{{ item.text }}</a></li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
            {% elif widget.children %}
                {# Dropdown link widget with children structure (legacy) #}
                <div class="dropdown mb-3" {{ build_container_style_attr(widget) }}>
                    <a class="btn btn-{{ widget.style|default('primary') }} dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false" {{ build_anchor_style_attr(widget) }}>
                        {{ widget.text }}
                    </a>
                    <ul class="dropdown-menu">
                        {% for child in widget.children %}
                            {% if child.children %}
                                {# Second level dropdown #}
                                <li class="dropend">
                                    <a class="dropdown-item dropdown-toggle" href="#">{{ child.text }}</a>
                                    <ul class="dropdown-menu">
                                        {% for grandchild in child.children %}
                                            {% if grandchild.children %}
                                                {# Third level dropdown #}
                                                <li class="dropend">
                                                    <a class="dropdown-item dropdown-toggle" href="#">{{ grandchild.text }}</a>
                                                    <ul class="dropdown-menu">
                                                        {% for great_grandchild in grandchild.children %}
                                                            <li><a class="dropdown-item" href="{{ great_grandchild.url }}">{{ great_grandchild.text }}</a></li>
                                                        {% endfor %}
                                                    </ul>
                                                </li>
                                            {% else %}
                                                <li><a class="dropdown-item" href="{{ grandchild.url }}">{{ grandchild.text }}</a></li>
                                            {% endif %}
                                        {% endfor %}
                                    </ul>
                                </li>
                            {% else %}
                                <li><a class="dropdown-item" href="{{ child.url }}">{{ child.text }}</a></li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
            {% else %}
                {# Simple link widget #}
                <a href="{{ widget.url }}" target="{{ widget.target|default('_self') }}" {{ build_style_attr(widget) }}>{{ widget.text }}</a>
            {% endif %}

        {% elif widget.type == 'card' %}
            <div class="card mb-3" {{ build_style_attr(widget) }}>
                {% if widget.image %}
                <img src="{{ widget.image }}" class="card-img-top" alt="{{ widget.title }}">
                {% endif %}
                <div class="card-body">
                    {% if widget.title %}
                    <h5 class="card-title">{{ widget.title }}</h5>
                    {% endif %}
                    {% if widget.content %}
                    <p class="card-text">{{ widget.content }}</p>
                    {% endif %}
                    {% if widget.url %}
                    <a href="{{ widget.url }}" class="btn btn-{{ widget.button_style|default('primary') }}">{{ widget.button_text|default('Learn More') }}</a>
                    {% endif %}
                </div>
            </div>

        {% elif widget.type == 'alert' %}
            <div class="alert alert-{{ widget.alert_type|default('info') }} mb-3" role="alert" {{ build_style_attr(widget) }}>
                {{ widget.content }}
            </div>

        {% elif widget.type == 'image' %}
            <div class="mb-3" {{ build_style_attr(widget) }}>
                <img src="{{ widget.src }}" class="img-fluid{% if widget.rounded %} rounded{% endif %}{% if widget.thumbnail %} img-thumbnail{% endif %}" alt="{{ widget.alt|default('') }}">
            </div>

        {% elif widget.type == 'video' %}
            <div class="mb-3 ratio ratio-16x9" {{ build_style_attr(widget) }}>
                <iframe src="{{ widget.url }}" allowfullscreen></iframe>
            </div>

        {% elif widget.type == 'accordion' %}
            <div class="accordion mb-3" id="accordion{{ loop.index }}" {{ build_style_attr(widget) }}>
                {% for item in widget.items %}
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button{% if not loop.first %} collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.parent.loop.index }}_{{ loop.index }}">
                            {{ item.title }}
                        </button>
                    </h2>
                    <div id="collapse{{ loop.parent.loop.index }}_{{ loop.index }}" class="accordion-collapse collapse{% if loop.first %} show{% endif %}" data-bs-parent="#accordion{{ loop.parent.loop.index }}">
                        <div class="accordion-body">
                            {{ item.content }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

        {% elif widget.type == 'breadcrumb' %}
            <nav aria-label="breadcrumb" {{ build_style_attr(widget) }}>
                <ol class="breadcrumb">
                    {% for item in widget.items %}
                    <li class="breadcrumb-item{% if loop.last %} active{% endif %}">
                        {% if loop.last %}
                            {{ item.text }}
                        {% else %}
                            <a href="{{ item.url }}">{{ item.text }}</a>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ol>
            </nav>

        {% elif widget.type == 'collapse' %}
            <div class="mb-3" {{ build_style_attr(widget) }}>
                <button class="btn btn-{{ widget.button_style|default('primary') }}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                    {{ widget.button_text }}
                </button>
                <div class="collapse mt-2" id="collapse{{ loop.index }}">
                    <div class="card card-body">
                        {{ widget.content }}
                    </div>
                </div>
            </div>

        {% elif widget.type == 'tabs' %}
            <div class="mb-3" {{ build_style_attr(widget) }}>
                <ul class="nav nav-tabs" role="tablist">
                    {% for tab in widget.tabs %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link{% if loop.first %} active{% endif %}" id="tab{{ loop.parent.loop.index }}_{{ loop.index }}-tab" data-bs-toggle="tab" data-bs-target="#tab{{ loop.parent.loop.index }}_{{ loop.index }}" type="button" role="tab">
                            {{ tab.title }}
                        </button>
                    </li>
                    {% endfor %}
                </ul>
                <div class="tab-content mt-3">
                    {% for tab in widget.tabs %}
                    <div class="tab-pane fade{% if loop.first %} show active{% endif %}" id="tab{{ loop.parent.loop.index }}_{{ loop.index }}" role="tabpanel">
                        {{ tab.content }}
                    </div>
                    {% endfor %}
                </div>
            </div>

        {% elif widget.type == 'caspio' %}
            {% if widget.deployUrl %}
            <div class="caspio-embed mb-3{% if widget.hidden %} d-none{% endif %}" {{ build_style_attr(widget) }} {% if widget.datapageKey %}data-caspio-key="{{ widget.datapageKey }}"{% endif %}>
                <script type="text/javascript" src="{{ widget.deployUrl }}/emb"></script>
            </div>
            {% endif %}

        {% elif widget.type == 'modal' %}
            {# Modal trigger button #}
            <button type="button" class="btn btn-{{ widget.buttonStyle or 'primary' }} mb-3"
                    data-bs-toggle="modal" data-bs-target="#{{ widget.modalId }}"
                    {{ build_style_attr(widget) }}>
                {{ widget.buttonText or 'Open Modal' }}
            </button>

            {# Modal dialog - rendered at page level, collected for later output #}
            {% if not _modals_collected %}
                {% set _modals_collected = [] %}
            {% endif %}

        {% endif %}
    {% endmacro %}

    {# Macro to render modal dialogs - call this at page bottom #}
    {% macro render_modal(widget) %}
        {% set size_class = '' %}
        {% if widget.modalSize == 'sm' %}{% set size_class = 'modal-sm' %}
        {% elif widget.modalSize == 'lg' %}{% set size_class = 'modal-lg' %}
        {% elif widget.modalSize == 'xl' %}{% set size_class = 'modal-xl' %}
        {% elif widget.modalSize == 'fullscreen' %}{% set size_class = 'modal-fullscreen' %}
        {% endif %}

        <div class="modal fade" id="{{ widget.modalId }}" tabindex="-1" aria-labelledby="{{ widget.modalId }}Label" aria-hidden="true">
            <div class="modal-dialog {{ size_class }} modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="{{ widget.modalId }}Label">{{ widget.modalTitle or 'Modal' }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        {% for child in widget.children or [] %}
                            {{ render_widget(child) }}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    {% endmacro %}

    {# Helper macro to collect all modals from widget list #}
    {% macro collect_modals(widget_list) %}
        {% for widget in widget_list %}
            {% if widget.type == 'modal' %}
                {{ render_modal(widget) }}
            {% elif widget.type == 'row' and widget.children %}
                {% for col in widget.children %}
                    {% if col.children %}
                        {{ collect_modals(col.children) }}
                    {% endif %}
                {% endfor %}
            {% elif widget.type == 'column' and widget.children %}
                {{ collect_modals(widget.children) }}
            {% endif %}
        {% endfor %}
    {% endmacro %}

    <div class="preview-banner">
        <small><i class="bi bi-eye"></i> Preview Mode - <a href="/page/{{ page.id }}/edit" class="text-white">Back to Editor</a></small>
    </div>

    {% if top_menu %}
    <nav class="navbar navbar-expand-lg navbar-light menu-top{% if top_menu.is_sticky|default(false) %} sticky-top{% endif %}"{% if top_menu_styles %} style="{% if top_menu_styles.get('backgroundColor') %}background-color: {{ top_menu_styles.get('backgroundColor') }}; {% endif %}{% if top_menu_styles.get('color') %}color: {{ top_menu_styles.get('color') }}; {% endif %}{% if top_menu_styles.get('textDecoration') %}text-decoration: {{ top_menu_styles.get('textDecoration') }}; {% endif %}{% if top_menu_styles.get('fontWeight') %}font-weight: {{ top_menu_styles.get('fontWeight') }}; {% endif %}{% if top_menu_styles.get('fontStyle') %}font-style: {{ top_menu_styles.get('fontStyle') }}; {% endif %}{% if top_menu_styles.get('backgroundImage') %}background-image: url('{{ top_menu_styles.get('backgroundImage') }}'); background-repeat: no-repeat; {% endif %}{% if top_menu_styles.get('backgroundSize') %}background-size: {{ top_menu_styles.get('backgroundSize') }}; {% endif %}{% if top_menu_styles.get('backgroundPosition') %}background-position: {{ top_menu_styles.get('backgroundPosition') }}; {% endif %}{% if top_menu_styles.get('borderTop') %}border-top: {{ top_menu_styles.get('borderTop') }}; {% endif %}{% if top_menu_styles.get('borderRight') %}border-right: {{ top_menu_styles.get('borderRight') }}; {% endif %}{% if top_menu_styles.get('borderBottom') %}border-bottom: {{ top_menu_styles.get('borderBottom') }}; {% endif %}{% if top_menu_styles.get('borderLeft') %}border-left: {{ top_menu_styles.get('borderLeft') }}; {% endif %}{% if top_menu_styles.get('borderRadius') %}border-radius: {{ top_menu_styles.get('borderRadius') }}; {% endif %}{% if top_menu_styles.get('boxShadow') %}box-shadow: {{ top_menu_styles.get('boxShadow') }}; {% endif %}{% if top_menu_styles.get('padding') %}padding: {{ top_menu_styles.get('padding') }}; {% endif %}{% if top_menu_styles.get('margin') %}margin: {{ top_menu_styles.get('margin') }}; {% endif %}{% if top_menu_styles.get('width') %}width: {{ top_menu_styles.get('width') }}; {% endif %}{% if top_menu_styles.get('height') %}height: {{ top_menu_styles.get('height') }}; {% endif %}{% if top_menu_styles.get('custom') %}{{ top_menu_styles.get('custom') }}; {% endif %}"{% endif %}>
        {% if top_menu_content %}
        <div class="container-fluid mt-2">
            {% for widget in top_menu_content %}
                {{ render_widget(widget) }}
            {% endfor %}
        </div>
        {% endif %}
    </nav>
    {% endif %}

    <div class="{% if left_menu or right_menu %}page-with-sidebar{% endif %}">
        {% if left_menu %}
        <aside class="menu-left"{% if left_menu_styles %} style="{% if left_menu_styles.get('backgroundColor') %}background-color: {{ left_menu_styles.get('backgroundColor') }}; {% endif %}{% if left_menu_styles.get('color') %}color: {{ left_menu_styles.get('color') }}; {% endif %}{% if left_menu_styles.get('textDecoration') %}text-decoration: {{ left_menu_styles.get('textDecoration') }}; {% endif %}{% if left_menu_styles.get('fontWeight') %}font-weight: {{ left_menu_styles.get('fontWeight') }}; {% endif %}{% if left_menu_styles.get('fontStyle') %}font-style: {{ left_menu_styles.get('fontStyle') }}; {% endif %}{% if left_menu_styles.get('backgroundImage') %}background-image: url('{{ left_menu_styles.get('backgroundImage') }}'); background-repeat: no-repeat; {% endif %}{% if left_menu_styles.get('backgroundSize') %}background-size: {{ left_menu_styles.get('backgroundSize') }}; {% endif %}{% if left_menu_styles.get('backgroundPosition') %}background-position: {{ left_menu_styles.get('backgroundPosition') }}; {% endif %}{% if left_menu_styles.get('borderTop') %}border-top: {{ left_menu_styles.get('borderTop') }}; {% endif %}{% if left_menu_styles.get('borderRight') %}border-right: {{ left_menu_styles.get('borderRight') }}; {% endif %}{% if left_menu_styles.get('borderBottom') %}border-bottom: {{ left_menu_styles.get('borderBottom') }}; {% endif %}{% if left_menu_styles.get('borderLeft') %}border-left: {{ left_menu_styles.get('borderLeft') }}; {% endif %}{% if left_menu_styles.get('borderRadius') %}border-radius: {{ left_menu_styles.get('borderRadius') }}; {% endif %}{% if left_menu_styles.get('boxShadow') %}box-shadow: {{ left_menu_styles.get('boxShadow') }}; {% endif %}{% if left_menu_styles.get('padding') %}padding: {{ left_menu_styles.get('padding') }}; {% endif %}{% if left_menu_styles.get('margin') %}margin: {{ left_menu_styles.get('margin') }}; {% endif %}{% if left_menu_styles.get('width') %}width: {{ left_menu_styles.get('width') }}; {% endif %}{% if left_menu_styles.get('height') %}height: {{ left_menu_styles.get('height') }}; {% endif %}{% if left_menu_styles.get('custom') %}{{ left_menu_styles.get('custom') }}; {% endif %}"{% endif %}>
            <nav class="nav flex-column">
                {% for item in left_menu_items %}
                {% if item.link_type == 'page' %}
                <a class="nav-link" href="/site/{{ site.id }}/{{ item.page.slug if item.page else '#' }}">{{ item.label }}</a>
                {% else %}
                <a class="nav-link" href="{{ item.custom_url }}">{{ item.label }}</a>
                {% endif %}
                {% endfor %}
            </nav>
            {% if left_menu_content %}
            <div class="mt-3">
                {% for widget in left_menu_content %}
                    {{ render_widget(widget) }}
                {% endfor %}
            </div>
            {% endif %}
        </aside>
        {% endif %}

        <div class="page-content-wrapper"{% if page_styles and page_styles is mapping and (page_styles.get('padding') or page_styles.get('margin')) %} style="{% if page_styles.get('padding') %}padding: {{ page_styles.get('padding') }}; {% endif %}{% if page_styles.get('margin') %}margin: {{ page_styles.get('margin') }}; {% endif %}"{% endif %}>
            <div class="container-fluid">
                {% for widget in content %}
                    {{ render_widget(widget) }}
                {% endfor %}
            </div>
        </div>

        {% if right_menu %}
        <aside class="menu-right"{% if right_menu_styles %} style="{% if right_menu_styles.get('backgroundColor') %}background-color: {{ right_menu_styles.get('backgroundColor') }}; {% endif %}{% if right_menu_styles.get('color') %}color: {{ right_menu_styles.get('color') }}; {% endif %}{% if right_menu_styles.get('textDecoration') %}text-decoration: {{ right_menu_styles.get('textDecoration') }}; {% endif %}{% if right_menu_styles.get('fontWeight') %}font-weight: {{ right_menu_styles.get('fontWeight') }}; {% endif %}{% if right_menu_styles.get('fontStyle') %}font-style: {{ right_menu_styles.get('fontStyle') }}; {% endif %}{% if right_menu_styles.get('backgroundImage') %}background-image: url('{{ right_menu_styles.get('backgroundImage') }}'); background-repeat: no-repeat; {% endif %}{% if right_menu_styles.get('backgroundSize') %}background-size: {{ right_menu_styles.get('backgroundSize') }}; {% endif %}{% if right_menu_styles.get('backgroundPosition') %}background-position: {{ right_menu_styles.get('backgroundPosition') }}; {% endif %}{% if right_menu_styles.get('borderTop') %}border-top: {{ right_menu_styles.get('borderTop') }}; {% endif %}{% if right_menu_styles.get('borderRight') %}border-right: {{ right_menu_styles.get('borderRight') }}; {% endif %}{% if right_menu_styles.get('borderBottom') %}border-bottom: {{ right_menu_styles.get('borderBottom') }}; {% endif %}{% if right_menu_styles.get('borderLeft') %}border-left: {{ right_menu_styles.get('borderLeft') }}; {% endif %}{% if right_menu_styles.get('borderRadius') %}border-radius: {{ right_menu_styles.get('borderRadius') }}; {% endif %}{% if right_menu_styles.get('boxShadow') %}box-shadow: {{ right_menu_styles.get('boxShadow') }}; {% endif %}{% if right_menu_styles.get('padding') %}padding: {{ right_menu_styles.get('padding') }}; {% endif %}{% if right_menu_styles.get('margin') %}margin: {{ right_menu_styles.get('margin') }}; {% endif %}{% if right_menu_styles.get('width') %}width: {{ right_menu_styles.get('width') }}; {% endif %}{% if right_menu_styles.get('height') %}height: {{ right_menu_styles.get('height') }}; {% endif %}{% if right_menu_styles.get('custom') %}{{ right_menu_styles.get('custom') }}; {% endif %}"{% endif %}>
            <nav class="nav flex-column">
                {% for item in right_menu_items %}
                {% if item.link_type == 'page' %}
                <a class="nav-link" href="/site/{{ site.id }}/{{ item.page.slug if item.page else '#' }}">{{ item.label }}</a>
                {% else %}
                <a class="nav-link" href="{{ item.custom_url }}">{{ item.label }}</a>
                {% endif %}
                {% endfor %}
            </nav>
            {% if right_menu_content %}
            <div class="mt-3">
                {% for widget in right_menu_content %}
                    {{ render_widget(widget) }}
                {% endfor %}
            </div>
            {% endif %}
        </aside>
        {% endif %}
    </div>

    {% if footer %}
    <footer>
        <div class="container">
            {% for widget in footer_content %}
                {{ render_widget(widget) }}
            {% endfor %}
        </div>
    </footer>
    {% endif %}

    {# Render all modal dialogs at the bottom of the page #}
    {{ collect_modals(content) }}
    {% if top_menu_content %}{{ collect_modals(top_menu_content) }}{% endif %}
    {% if left_menu_content %}{{ collect_modals(left_menu_content) }}{% endif %}
    {% if right_menu_content %}{{ collect_modals(right_menu_content) }}{% endif %}
    {% if footer_content %}{{ collect_modals(footer_content) }}{% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    {# Site-wide modal opener function #}
    <script>
    window.openSiteModal = function(modalId, params = {}) {
        const modal = document.getElementById(modalId);
        if (!modal) {
            console.error('Modal not found:', modalId);
            return;
        }

        // If params provided, update any Caspio embeds inside the modal
        if (Object.keys(params).length > 0) {
            const caspioEmbeds = modal.querySelectorAll('.caspio-embed script');
            caspioEmbeds.forEach(script => {
                let src = script.getAttribute('src') || script.dataset.originalSrc;
                if (!script.dataset.originalSrc) {
                    script.dataset.originalSrc = src;
                }
                const url = new URL(src);
                Object.entries(params).forEach(([key, value]) => {
                    if (value != null) url.searchParams.set(key, value);
                });
                // Replace the script to reload with new params
                const newScript = document.createElement('script');
                newScript.type = 'text/javascript';
                newScript.src = url.toString();
                newScript.dataset.originalSrc = script.dataset.originalSrc;
                script.parentNode.replaceChild(newScript, script);
            });
        }

        // Show the modal
        const bsModal = bootstrap.Modal.getOrCreateInstance(modal);
        bsModal.show();
    };

    // Allow calling from Caspio datapages via data attributes
    document.addEventListener('click', function(e) {
        const trigger = e.target.closest('[data-open-modal]');
        if (trigger) {
            e.preventDefault();
            const modalId = trigger.dataset.openModal;
            const params = {};
            // Collect data-param-* attributes
            Object.entries(trigger.dataset).forEach(([key, value]) => {
                if (key.startsWith('param') && key !== 'params') {
                    const paramName = key.slice(5);
                    params[paramName.charAt(0).toLowerCase() + paramName.slice(1)] = value;
                }
            });
            // Also check for data-params JSON
            if (trigger.dataset.params) {
                try { Object.assign(params, JSON.parse(trigger.dataset.params)); } catch(e) {}
            }
            openSiteModal(modalId, params);
        }
    });
    </script>
</body>
</html>
