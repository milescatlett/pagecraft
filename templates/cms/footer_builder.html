{% extends "base.html" %}

{% block title %}Edit {{ footer.name }} - Footer Builder{% endblock %}

{% block body %}
<div class="cms-container">
    <nav class="cms-sidebar">
        <div class="sidebar-header">
            <h4><i class="bi bi-file-earmark-richtext"></i> PageCraft</h4>
        </div>
        <ul class="sidebar-menu">
            <li><a href="{{ url_for('cms.index') }}"><i class="bi bi-house-door"></i> Dashboard</a></li>
            <li><a href="{{ url_for('cms.images') }}"><i class="bi bi-images"></i> Images</a></li>
            {% if current_user.is_admin %}
            <li><a href="{{ url_for('users.users_list') }}"><i class="bi bi-people"></i> Users</a></li>
            {% endif %}
            <li><a href="{{ url_for('cms.site_detail', site_id=site.id) }}"><i class="bi bi-globe"></i> {{ site.name }}</a></li>
            <li><a href="{{ url_for('cms.documentation') }}"><i class="bi bi-journal-text"></i> Documentation</a></li>
        </ul>
        <div class="sidebar-footer">
            <div class="user-info">
                <i class="bi bi-person-circle"></i>
                <span>{{ current_user.username }}</span>
            </div>
            <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-light btn-sm w-100">
                <i class="bi bi-box-arrow-left"></i> Logout
            </a>
        </div>
    </nav>

    <main class="cms-main">
        <div class="cms-header">
            <div>
                <h1>Edit Footer: {{ footer.name }}</h1>
                <p class="text-muted">Build your footer using drag and drop</p>
            </div>
            <div>
                <a href="/site/{{ site.id }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Site
                </a>
                <button class="btn btn-primary" onclick="saveFooter()">
                    <i class="bi bi-save"></i> Save Footer
                </button>
            </div>
        </div>

        <div class="cms-content">
            <div class="row">
                <div class="col-md-3">
                    <div class="section-card">
                        <div class="section-header">
                            <h5>Settings</h5>
                        </div>
                        <div class="section-body">
                            <div class="mb-3">
                                <label class="form-label">Footer Name</label>
                                <input type="text" class="form-control form-control-sm" id="footerName" value="{{ footer.name }}">
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="footerActive" {% if footer.is_active %}checked{% endif %}>
                                    <label class="form-check-label" for="footerActive">
                                        Active
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="editFooterStyles()">
                                    <i class="bi bi-palette"></i> Footer Styling
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="section-card mt-3">
                        <div class="section-header">
                            <h5>Layout</h5>
                        </div>
                        <div class="section-body">
                            <div class="widget-item-small" draggable="true" data-widget-type="row">
                                <i class="bi bi-layout-three-columns"></i>
                                <span>Row</span>
                            </div>
                        </div>
                    </div>

                    <div class="section-card mt-3">
                        <div class="section-header">
                            <h5>Widgets</h5>
                        </div>
                        <div class="section-body">
                            <div class="widget-item-small" draggable="true" data-widget-type="heading">
                                <i class="bi bi-type-h1"></i>
                                <span>Heading</span>
                            </div>
                            <div class="widget-item-small" draggable="true" data-widget-type="text">
                                <i class="bi bi-fonts"></i>
                                <span>Text</span>
                            </div>
                            <div class="widget-item-small" draggable="true" data-widget-type="richtext">
                                <i class="bi bi-card-text"></i>
                                <span>Rich Text</span>
                            </div>
                            <div class="widget-item-small" draggable="true" data-widget-type="html">
                                <i class="bi bi-code-square"></i>
                                <span>HTML</span>
                            </div>
                            <div class="widget-item-small" draggable="true" data-widget-type="separator">
                                <i class="bi bi-dash-lg"></i>
                                <span>Separator</span>
                            </div>
                            <div class="widget-item-small" draggable="true" data-widget-type="button">
                                <i class="bi bi-hand-index"></i>
                                <span>Button</span>
                            </div>
                            <div class="widget-item-small" draggable="true" data-widget-type="link">
                                <i class="bi bi-link"></i>
                                <span>Link</span>
                            </div>
                            <div class="widget-item-small" draggable="true" data-widget-type="card">
                                <i class="bi bi-card-heading"></i>
                                <span>Card</span>
                            </div>
                            <div class="widget-item-small" draggable="true" data-widget-type="alert">
                                <i class="bi bi-exclamation-triangle"></i>
                                <span>Alert</span>
                            </div>
                            <div class="widget-item-small" draggable="true" data-widget-type="image">
                                <i class="bi bi-image"></i>
                                <span>Image</span>
                            </div>
                            <div class="widget-item-small" draggable="true" data-widget-type="video">
                                <i class="bi bi-play-circle"></i>
                                <span>Video</span>
                            </div>
                            <div class="widget-item-small" draggable="true" data-widget-type="accordion">
                                <i class="bi bi-menu-button-wide"></i>
                                <span>Accordion</span>
                            </div>
                            <div class="widget-item-small" draggable="true" data-widget-type="breadcrumb">
                                <i class="bi bi-signpost"></i>
                                <span>Breadcrumb</span>
                            </div>
                            <div class="widget-item-small" draggable="true" data-widget-type="collapse">
                                <i class="bi bi-arrows-collapse"></i>
                                <span>Collapse</span>
                            </div>
                            <div class="widget-item-small" draggable="true" data-widget-type="tabs">
                                <i class="bi bi-folder"></i>
                                <span>Tabs</span>
                            </div>
                            <div class="widget-item-small" draggable="true" data-widget-type="links">
                                <i class="bi bi-link-45deg"></i>
                                <span>Links</span>
                            </div>
                            <div class="widget-item-small" draggable="true" data-widget-type="social">
                                <i class="bi bi-share"></i>
                                <span>Social</span>
                            </div>
                            <div class="widget-item-small" draggable="true" data-widget-type="copyright">
                                <i class="bi bi-c-circle"></i>
                                <span>Copyright</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="footer-builder-canvas">
                        <div class="footer-preview" id="footerCanvas">
                            <div class="footer-drop-zone" id="footerDropZone">
                                <i class="bi bi-plus-circle"></i>
                                <p>Drag widgets here to build your footer</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Caspio DataPages Sidebar -->
                <div class="col-md-3">
                    <div class="section-card">
                        <div class="section-header d-flex justify-content-between align-items-center">
                            <h5><i class="bi bi-database"></i> Caspio DataPages</h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="refreshCaspioDatapages()" title="Refresh">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        <div class="section-body caspio-sidebar-content" id="caspioSidebarContent">
                            <div class="text-center py-4">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div class="mt-2 small text-muted">Loading DataPages...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Widget Edit Modal -->
<div class="modal fade" id="widgetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="widgetModalTitle">Edit Widget</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="widgetModalBody">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveWidgetEdit()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Image Gallery Modal -->
<div class="modal fade" id="imageGalleryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Image Gallery</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="galleryTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="browse-tab" data-bs-toggle="tab" data-bs-target="#browse" type="button" role="tab">
                            <i class="bi bi-images"></i> Browse Images
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">
                            <i class="bi bi-cloud-upload"></i> Upload New
                        </button>
                    </li>
                </ul>
                <div class="tab-content mt-3" id="galleryTabContent">
                    <div class="tab-pane fade show active" id="browse" role="tabpanel">
                        <div id="galleryLoading" class="text-center py-5" style="display: none;">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="galleryEmpty" class="text-center py-5 text-muted" style="display: none;">
                            <i class="bi bi-images" style="font-size: 3rem;"></i>
                            <p>No images uploaded yet</p>
                        </div>
                        <div class="row g-3" id="galleryGrid" style="display: none;">
                            <!-- Images will be loaded here -->
                        </div>
                    </div>
                    <div class="tab-pane fade" id="upload" role="tabpanel">
                        <form id="uploadForm" class="p-4">
                            <div class="mb-3">
                                <label for="fileInput" class="form-label">Select Image</label>
                                <input type="file" class="form-control" id="fileInput" accept="image/*">
                                <small class="text-muted">Supported formats: PNG, JPG, JPEG, GIF, WebP, SVG (Max 16MB)</small>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="uploadToGallery()">
                                <i class="bi bi-cloud-upload"></i> Upload Image
                            </button>
                        </form>
                        <div id="uploadProgress" class="mt-3" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .drag-handle {
        cursor: move;
        cursor: grab;
        padding: 0.25rem 0.5rem;
    }

    .drag-handle:active {
        cursor: grabbing;
    }

    .dragging {
        opacity: 0.5;
        background: #f8f9fa;
    }

    .widget-controls {
        opacity: 0.3;
        transition: opacity 0.2s;
    }

    .widget-block:hover .widget-controls {
        opacity: 1;
    }

    .row-container {
        border: 2px dashed #6c757d;
        border-radius: 8px;
        margin-bottom: 1rem;
        background: #f8f9fa;
    }

    .row-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 1rem;
        background: #e9ecef;
        border-bottom: 1px solid #dee2e6;
        border-radius: 6px 6px 0 0;
    }

    .row-label {
        font-weight: 500;
        color: #495057;
    }

    .row-label i {
        margin-right: 0.5rem;
    }

    .row-controls {
        display: flex;
        gap: 0.25rem;
    }

    .row-content {
        display: flex;
        padding: 0.5rem;
        gap: 0.5rem;
    }

    .column-container {
        border: 1px dashed #adb5bd;
        border-radius: 6px;
        background: white;
        min-height: 100px;
    }

    .column-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.25rem 0.5rem;
        background: #e9ecef;
        border-bottom: 1px solid #dee2e6;
        font-size: 0.85rem;
    }

    .column-label {
        color: #6c757d;
    }

    .column-label i {
        margin-right: 0.25rem;
    }

    .column-controls {
        display: flex;
        gap: 0.25rem;
    }

    .column-content {
        padding: 0.5rem;
        min-height: 80px;
    }

    .column-content .drop-zone {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 60px;
        border: 2px dashed #dee2e6;
        border-radius: 4px;
        color: #adb5bd;
    }

    .drop-zone-target.drag-over {
        background-color: #e7f5ff;
        border-color: #228be6;
    }

    .widget-block {
        position: relative;
        padding: 0.75rem;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        background: white;
    }

    .widget-block.top-level {
        margin-bottom: 1rem;
    }

    .widget-block .widget-controls {
        position: absolute;
        top: 0.25rem;
        right: 0.25rem;
        display: flex;
        gap: 0.25rem;
    }

    .footer-preview {
        min-height: 200px;
    }

    /* Caspio Sidebar Styles */
    .caspio-sidebar-content {
        max-height: 500px;
        overflow-y: auto;
    }

    .caspio-app-group {
        border-bottom: 1px solid #dee2e6;
    }

    .caspio-app-group:last-child {
        border-bottom: none;
    }

    .caspio-app-header {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        cursor: pointer;
        background: #f8f9fa;
        font-weight: 500;
        font-size: 0.85rem;
    }

    .caspio-app-header:hover {
        background: #e9ecef;
    }

    .caspio-app-content {
        padding-left: 0.5rem;
    }

    .caspio-folder-group {
        margin-left: 0.5rem;
    }

    .caspio-folder-header {
        display: flex;
        align-items: center;
        padding: 0.35rem 0.5rem;
        cursor: pointer;
        font-size: 0.8rem;
        color: #6c757d;
    }

    .caspio-folder-header:hover {
        background: #f8f9fa;
    }

    .caspio-folder-content {
        padding-left: 0.5rem;
    }

    .caspio-datapage-item {
        display: flex;
        align-items: center;
        padding: 0.35rem 0.5rem;
        margin: 0.15rem 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        cursor: grab;
        font-size: 0.8rem;
        transition: all 0.2s;
    }

    .caspio-datapage-item:hover {
        background: #e7f1ff;
        border-color: #0d6efd;
    }

    .caspio-datapage-item:active {
        cursor: grabbing;
    }

    .toggle-icon {
        transition: transform 0.2s;
        font-size: 0.7rem;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// CSRF token helper function
function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]').content;
}

// Helper to get headers with CSRF token for fetch requests
function getHeaders() {
    return {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
    };
}

const siteId = {{ footer.site_id }};
const footerId = {{ footer.id }};
let widgets = {{ footer.content|safe }};
let currentEditingWidget = null;
let widgetModal = null;
let sortableInstance = null;
const sitePages = {{ pages|tojson }};
let imageGalleryModal = null;
let currentImageInputId = null;
let footerStyles = {{ footer_styles|tojson }};

// Helper function to build inline style string from styles object
function buildInlineStyle(styles) {
    if (!styles || Object.keys(styles).length === 0) return '';
    let styleStr = ' style="';
    if (styles.color) styleStr += `color: ${styles.color}; `;
    if (styles.textDecoration) styleStr += `text-decoration: ${styles.textDecoration}; `;
    if (styles.fontWeight) styleStr += `font-weight: ${styles.fontWeight}; `;
    if (styles.fontSize) styleStr += `font-size: ${styles.fontSize}; `;
    if (styles.backgroundColor) styleStr += `background-color: ${styles.backgroundColor}; `;
    styleStr += '"';
    return styleStr === ' style=""' ? '' : styleStr;
}

document.addEventListener('DOMContentLoaded', function() {
    widgetModal = new bootstrap.Modal(document.getElementById('widgetModal'));
    imageGalleryModal = new bootstrap.Modal(document.getElementById('imageGalleryModal'));
    initializeBuilder();
    renderWidgets();
    loadCaspioDatapages();
});

function initializeBuilder() {
    const canvas = document.getElementById('footerCanvas');

    const widgetItems = document.querySelectorAll('.widget-item-small');
    widgetItems.forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
    });

    canvas.addEventListener('dragover', handleDragOver);
    canvas.addEventListener('drop', handleDrop);
}

function setupFooterSorting() {
    const canvas = document.getElementById('footerCanvas');

    // Destroy existing Sortable instance
    if (sortableInstance) {
        sortableInstance.destroy();
    }

    // Set up sorting for top-level elements (rows and widgets)
    if (canvas.children.length > 0) {
        sortableInstance = new Sortable(canvas, {
            animation: 150,
            ghostClass: 'dragging',
            handle: '.drag-handle',
            draggable: '.row-container, .widget-block.top-level',
            onEnd: function() {
                updateWidgetOrder();
            }
        });
    }

    // Set up sorting within each column
    document.querySelectorAll('.column-content').forEach((columnContent, idx) => {
        new Sortable(columnContent, {
            animation: 150,
            ghostClass: 'dragging',
            handle: '.drag-handle',
            draggable: '.widget-block',
            group: 'column-widgets',
            onEnd: function(evt) {
                updateColumnWidgetOrder(evt);
            }
        });
    });
}

function handleDragStart(e) {
    e.dataTransfer.setData('widgetType', e.currentTarget.dataset.widgetType);
}

function handleDragOver(e) {
    e.preventDefault();
}

function handleDrop(e) {
    e.preventDefault();
    const widgetType = e.dataTransfer.getData('widgetType');
    if (widgetType) {
        // Check if it's a caspio widget and pass extra data
        if (widgetType === 'caspio') {
            const caspioData = {
                datapageName: e.dataTransfer.getData('caspioDatapageName'),
                datapageKey: e.dataTransfer.getData('caspioDatapageKey'),
                appName: e.dataTransfer.getData('caspioAppName'),
                deployUrl: e.dataTransfer.getData('caspioDeployUrl')
            };
            addWidget(widgetType, caspioData);
        } else {
            addWidget(widgetType, null);
        }
    }
}

function addWidget(type, extraData = null) {
    const widget = createWidget(type, extraData);
    widgets.push(widget);
    renderWidgets();
}

function createWidget(type, extraData = null) {
    const baseWidget = {
        id: Date.now() + '-' + Math.floor(Math.random() * 100000),
        type: type
    };

    switch(type) {
        case 'row':
            return {...baseWidget, numColumns: 2, children: []};
        case 'column':
            return {...baseWidget, width: 6, children: []};
        case 'heading':
            return {...baseWidget, content: 'New Heading', level: 'h2'};
        case 'text':
            return {...baseWidget, content: 'Footer text content'};
        case 'richtext':
            return {...baseWidget, content: 'Enter your text here...'};
        case 'html':
            return {...baseWidget, content: '<p>Custom HTML</p>'};
        case 'separator':
            return {...baseWidget};
        case 'button':
            return {...baseWidget, text: 'Click Me', url: '#', style: 'primary', dropdownItems: []};
        case 'link':
            return {...baseWidget, text: 'Link Text', url: '#', target: '_self', dropdownItems: []};
        case 'card':
            return {...baseWidget, title: 'Card Title', content: 'Card content', image: ''};
        case 'alert':
            return {...baseWidget, content: 'Alert message', style: 'info'};
        case 'image':
            return {...baseWidget, src: 'https://via.placeholder.com/800x400', alt: 'Image'};
        case 'video':
            return {...baseWidget, url: ''};
        case 'accordion':
            return {...baseWidget, items: [
                {title: 'Item 1', content: 'Content for item 1', expanded: true},
                {title: 'Item 2', content: 'Content for item 2', expanded: false}
            ]};
        case 'breadcrumb':
            return {...baseWidget, items: [
                {text: 'Home', url: '#'},
                {text: 'Current', url: '', active: true}
            ]};
        case 'collapse':
            return {...baseWidget, title: 'Click to toggle', content: 'Hidden content here...', expanded: false};
        case 'tabs':
            return {...baseWidget, tabs: [
                {title: 'Tab 1', content: 'Content for tab 1', active: true},
                {title: 'Tab 2', content: 'Content for tab 2', active: false}
            ]};
        case 'links':
            return {...baseWidget, title: 'Quick Links', links: [{text: 'Link 1', url: '#'}]};
        case 'social':
            return {...baseWidget, title: 'Follow Us', platforms: []};
        case 'copyright':
            return {...baseWidget, text: 'Â© 2025 Your Company. All rights reserved.'};
        case 'caspio':
            if (extraData) {
                return {...baseWidget,
                    appName: extraData.appName || '',
                    datapageName: extraData.datapageName || '',
                    datapageKey: extraData.datapageKey || '',
                    deployUrl: extraData.deployUrl || ''
                };
            }
            return {...baseWidget, appName: '', datapageName: '', datapageKey: '', deployUrl: ''};
        default:
            return baseWidget;
    }
}

function renderWidgets() {
    const canvas = document.getElementById('footerCanvas');

    if (widgets.length === 0) {
        canvas.innerHTML = `
            <div class="footer-drop-zone" id="footerDropZone">
                <i class="bi bi-plus-circle"></i>
                <p>Drag widgets here to build your footer</p>
            </div>
        `;
        return;
    }

    canvas.innerHTML = widgets.map((widget, index) => {
        if (widget.type === 'row') {
            return renderRow(widget, index);
        } else {
            return renderTopLevelWidget(widget, index);
        }
    }).join('');

    setTimeout(() => {
        setupFooterSorting();
        setupColumnDropZones();
    }, 0);
}

function renderRow(widget, index) {
    const numCols = widget.numColumns || 2;
    const colWidth = Math.floor(12 / numCols);

    // Ensure we have the right number of columns
    if (!widget.children) widget.children = [];
    while (widget.children.length < numCols) {
        widget.children.push({
            id: Date.now() + '-' + Math.floor(Math.random() * 100000) + '-' + widget.children.length,
            type: 'column',
            width: colWidth,
            children: []
        });
    }
    while (widget.children.length > numCols) {
        widget.children.pop();
    }

    return `
        <div class="row-container" data-index="${index}">
            <div class="row-header">
                <div class="row-label">
                    <i class="bi bi-layout-three-columns"></i>
                    Row (${numCols} columns)
                </div>
                <div class="row-controls">
                    <span class="drag-handle btn btn-sm btn-outline-secondary">
                        <i class="bi bi-grip-vertical"></i>
                    </span>
                    <button class="btn btn-sm btn-outline-primary" onclick="editRow(${index})">
                        <i class="bi bi-gear"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteWidget('${widget.id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            <div class="row-content">
                ${widget.children.map((col, colIndex) => renderColumn(col, index, colIndex)).join('')}
            </div>
        </div>
    `;
}

function renderColumn(column, rowIndex, colIndex) {
    return `
        <div class="column-container" data-row="${rowIndex}" data-col="${colIndex}" style="flex: ${column.width || 6};">
            <div class="column-header">
                <div class="column-label">
                    <i class="bi bi-layout-sidebar"></i>
                    Col ${colIndex + 1} (${column.width || 6}/12)
                </div>
                <div class="column-controls">
                    <button class="btn btn-sm btn-outline-primary" onclick="editColumn(${rowIndex}, ${colIndex})">
                        <i class="bi bi-pencil"></i>
                    </button>
                </div>
            </div>
            <div class="column-content drop-zone-target" data-drop-row="${rowIndex}" data-drop-col="${colIndex}">
                ${column.children && column.children.length > 0
                    ? column.children.map((child, childIndex) => renderNestedWidget(child, rowIndex, colIndex, childIndex)).join('')
                    : '<div class="drop-zone"><small>Drop widgets here</small></div>'}
            </div>
        </div>
    `;
}

function renderNestedWidget(widget, rowIndex, colIndex, childIndex) {
    let content = renderWidgetContent(widget);
    return `
        <div class="widget-block" data-widget-id="${widget.id}" data-row="${rowIndex}" data-col="${colIndex}" data-child="${childIndex}">
            <div class="widget-controls">
                <span class="drag-handle btn btn-sm btn-outline-secondary">
                    <i class="bi bi-grip-vertical"></i>
                </span>
                <button class="btn btn-sm btn-outline-primary" onclick="editNestedWidget(${rowIndex}, ${colIndex}, ${childIndex})">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteNestedWidget(${rowIndex}, ${colIndex}, ${childIndex})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            ${content}
        </div>
    `;
}

function renderTopLevelWidget(widget, index) {
    let content = renderWidgetContent(widget);
    return `
        <div class="widget-block top-level" data-widget-id="${widget.id}" data-index="${index}">
            <div class="widget-controls">
                <span class="drag-handle btn btn-sm btn-outline-secondary">
                    <i class="bi bi-grip-vertical"></i>
                </span>
                <button class="btn btn-sm btn-outline-primary" onclick="editWidget('${widget.id}')">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteWidget('${widget.id}')">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            ${content}
        </div>
    `;
}

function setupColumnDropZones() {
    const dropZones = document.querySelectorAll('.drop-zone-target');
    dropZones.forEach(zone => {
        zone.addEventListener('dragover', (e) => {
            e.preventDefault();
            zone.classList.add('drag-over');
        });
        zone.addEventListener('dragleave', (e) => {
            zone.classList.remove('drag-over');
        });
        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            zone.classList.remove('drag-over');

            const widgetType = e.dataTransfer.getData('widgetType');
            if (widgetType && widgetType !== 'row') {
                const rowIndex = parseInt(zone.dataset.dropRow);
                const colIndex = parseInt(zone.dataset.dropCol);

                // Check if it's a caspio widget and pass extra data
                if (widgetType === 'caspio') {
                    const caspioData = {
                        datapageName: e.dataTransfer.getData('caspioDatapageName'),
                        datapageKey: e.dataTransfer.getData('caspioDatapageKey'),
                        appName: e.dataTransfer.getData('caspioAppName'),
                        deployUrl: e.dataTransfer.getData('caspioDeployUrl')
                    };
                    addWidgetToColumn(rowIndex, colIndex, widgetType, caspioData);
                } else {
                    addWidgetToColumn(rowIndex, colIndex, widgetType, null);
                }
            }
        });
    });
}

function addWidgetToColumn(rowIndex, colIndex, type, extraData = null) {
    const widget = createWidget(type, extraData);
    if (widgets[rowIndex] && widgets[rowIndex].type === 'row') {
        if (!widgets[rowIndex].children[colIndex].children) {
            widgets[rowIndex].children[colIndex].children = [];
        }
        widgets[rowIndex].children[colIndex].children.push(widget);
        renderWidgets();
    }
}

function renderWidgetContent(widget) {
    let content = '';

    switch(widget.type) {
        case 'heading':
            content = `<${widget.level || 'h2'}>${widget.content}</${widget.level || 'h2'}>`;
            break;
        case 'text':
            content = `<p>${widget.content}</p>`;
            break;
        case 'richtext':
            content = `<div>${widget.content}</div>`;
            break;
        case 'html':
            content = `<div>${widget.content}</div>`;
            break;
        case 'separator':
            content = `<hr>`;
            break;
        case 'button':
            if (widget.dropdownItems && widget.dropdownItems.length > 0) {
                content = `
                    <div class="btn-group">
                        <button type="button" class="btn btn-${widget.style} dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            ${widget.text}
                        </button>
                        <ul class="dropdown-menu">
                            ${widget.dropdownItems.map(item => {
                                if (item.nestedItems && item.nestedItems.length > 0) {
                                    return `
                                        <li class="dropend">
                                            <a class="dropdown-item dropdown-toggle" href="${item.url || '#'}">${item.text}</a>
                                            <ul class="dropdown-menu">
                                                ${item.nestedItems.map(nested => `
                                                    <li><a class="dropdown-item" href="${nested.url}">${nested.text}</a></li>
                                                `).join('')}
                                            </ul>
                                        </li>
                                    `;
                                } else {
                                    return `<li><a class="dropdown-item" href="${item.url}">${item.text}</a></li>`;
                                }
                            }).join('')}
                        </ul>
                    </div>
                `;
            } else {
                content = `<a href="${widget.url}" class="btn btn-${widget.style}">${widget.text}</a>`;
            }
            break;
        case 'link':
            const linkStyle = buildInlineStyle(widget.styles);
            if (widget.dropdownItems && widget.dropdownItems.length > 0) {
                content = `
                    <div class="dropdown d-inline-block">
                        <a class="dropdown-toggle" href="${widget.url}" data-bs-toggle="dropdown"${linkStyle}>${widget.text}</a>
                        <ul class="dropdown-menu">
                            ${widget.dropdownItems.map(item => `
                                <li><a class="dropdown-item" href="${item.url}">${item.text}</a></li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            } else {
                content = `<a href="${widget.url}" target="${widget.target || '_self'}"${linkStyle}>${widget.text}</a>`;
            }
            break;
        case 'card':
            content = `
                <div class="card">
                    ${widget.image ? `<img src="${widget.image}" class="card-img-top" alt="Card image">` : ''}
                    <div class="card-body">
                        <h5 class="card-title">${widget.title}</h5>
                        <p class="card-text">${widget.content}</p>
                    </div>
                </div>
            `;
            break;
        case 'alert':
            content = `<div class="alert alert-${widget.style}">${widget.content}</div>`;
            break;
        case 'image':
            content = `<img src="${widget.src}" alt="${widget.alt}" class="img-fluid">`;
            break;
        case 'video':
            content = widget.url ? `
                <div class="ratio ratio-16x9">
                    <iframe src="${widget.url}" allowfullscreen></iframe>
                </div>
            ` : '<p class="text-muted">No video URL set</p>';
            break;
        case 'accordion':
            const accordionId = `accordion-${widget.id}`;
            content = `
                <div class="accordion" id="${accordionId}">
                    ${(widget.items || []).map((item, idx) => `
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button ${!item.expanded ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${widget.id}-${idx}">
                                    ${item.title}
                                </button>
                            </h2>
                            <div id="collapse-${widget.id}-${idx}" class="accordion-collapse collapse ${item.expanded ? 'show' : ''}" data-bs-parent="#${accordionId}">
                                <div class="accordion-body">${item.content}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            break;
        case 'breadcrumb':
            content = `
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        ${(widget.items || []).map(item => `
                            <li class="breadcrumb-item ${item.active ? 'active' : ''}">
                                ${item.active ? item.text : `<a href="${item.url}">${item.text}</a>`}
                            </li>
                        `).join('')}
                    </ol>
                </nav>
            `;
            break;
        case 'collapse':
            const collapseId = `collapse-${widget.id}`;
            content = `
                <div>
                    <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                        ${widget.title}
                    </button>
                    <div class="collapse ${widget.expanded ? 'show' : ''}" id="${collapseId}">
                        <div class="card card-body mt-2">
                            ${widget.content}
                        </div>
                    </div>
                </div>
            `;
            break;
        case 'tabs':
            const tabId = `tabs-${widget.id}`;
            content = `
                <div>
                    <ul class="nav nav-tabs" id="${tabId}" role="tablist">
                        ${(widget.tabs || []).map((tab, idx) => `
                            <li class="nav-item" role="presentation">
                                <button class="nav-link ${tab.active ? 'active' : ''}" id="tab-${widget.id}-${idx}" data-bs-toggle="tab" data-bs-target="#content-${widget.id}-${idx}" type="button" role="tab">
                                    ${tab.title}
                                </button>
                            </li>
                        `).join('')}
                    </ul>
                    <div class="tab-content pt-3">
                        ${(widget.tabs || []).map((tab, idx) => `
                            <div class="tab-pane fade ${tab.active ? 'show active' : ''}" id="content-${widget.id}-${idx}" role="tabpanel">
                                ${tab.content}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            break;
        case 'links':
            content = `
                <h6>${widget.title}</h6>
                <ul class="list-unstyled">
                    ${widget.links.map(link => `
                        <li><a href="${link.url}" class="text-decoration-none">${link.text}</a></li>
                    `).join('')}
                </ul>
            `;
            break;
        case 'social':
            content = `
                <h6>${widget.title}</h6>
                <div class="d-flex gap-2">
                    ${widget.platforms.map(platform => `
                        <a href="${platform.url}" class="btn btn-outline-light btn-sm">
                            <i class="bi bi-${platform.icon}"></i>
                        </a>
                    `).join('')}
                </div>
            `;
            break;
        case 'copyright':
            content = `<p class="mb-0 text-center">${widget.text}</p>`;
            break;
        case 'caspio':
            if (widget.datapageKey) {
                content = `
                    <div class="caspio-datapage-preview">
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-database"></i>
                            <strong>Caspio DataPage:</strong> ${widget.datapageName || 'Unknown'}
                            <br><small class="text-muted">App: ${widget.appName || 'Unknown'} | Key: ${widget.datapageKey}</small>
                        </div>
                    </div>
                `;
            } else {
                content = `<div class="alert alert-warning">Caspio DataPage not configured</div>`;
            }
            break;
    }

    return content;
}

function findWidgetById(widgetId) {
    // Search top-level widgets
    for (let widget of widgets) {
        if (widget.id === widgetId || widget.id == widgetId) return widget;
        // Search in row children
        if (widget.type === 'row' && widget.children) {
            for (let col of widget.children) {
                if (col.children) {
                    for (let child of col.children) {
                        if (child.id === widgetId || child.id == widgetId) return child;
                    }
                }
            }
        }
    }
    return null;
}

function getWidgetFormHtml(widget) {
    let formHtml = '';
    switch(widget.type) {
        case 'heading':
            formHtml = `
                <div class="mb-3">
                    <label class="form-label">Content</label>
                    <input type="text" class="form-control" id="widgetContent" value="${widget.content}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Level</label>
                    <select class="form-select" id="widgetLevel">
                        <option value="h1" ${widget.level === 'h1' ? 'selected' : ''}>H1</option>
                        <option value="h2" ${widget.level === 'h2' ? 'selected' : ''}>H2</option>
                        <option value="h3" ${widget.level === 'h3' ? 'selected' : ''}>H3</option>
                        <option value="h4" ${widget.level === 'h4' ? 'selected' : ''}>H4</option>
                        <option value="h5" ${widget.level === 'h5' ? 'selected' : ''}>H5</option>
                        <option value="h6" ${widget.level === 'h6' ? 'selected' : ''}>H6</option>
                    </select>
                </div>
            `;
            break;
        case 'text':
            formHtml = `
                <div class="mb-3">
                    <label class="form-label">Content</label>
                    <textarea class="form-control" id="widgetContent" rows="4">${widget.content}</textarea>
                </div>
            `;
            break;
        case 'richtext':
            formHtml = `
                <div class="mb-3">
                    <label class="form-label">Content</label>
                    <textarea class="form-control" id="widgetContent" rows="6">${widget.content}</textarea>
                </div>
            `;
            break;
        case 'html':
            formHtml = `
                <div class="mb-3">
                    <label class="form-label">HTML Code</label>
                    <textarea class="form-control" id="widgetContent" rows="10" style="font-family: monospace;">${widget.content}</textarea>
                </div>
            `;
            break;
        case 'separator':
            formHtml = `
                <div class="mb-3">
                    <p class="text-muted">Separator has no configurable options.</p>
                </div>
            `;
            break;
        case 'button':
            const dropdownItems = widget.dropdownItems || [];
            formHtml = `
                <div class="mb-3">
                    <label class="form-label">Button Text</label>
                    <input type="text" class="form-control" id="widgetText" value="${widget.text}">
                </div>
                <div class="mb-3">
                    <label class="form-label">URL</label>
                    <input type="text" class="form-control" id="widgetUrl" value="${widget.url}">
                    <small class="text-muted">Main button URL (used when no dropdown items)</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Style</label>
                    <select class="form-select" id="widgetStyle">
                        <option value="primary" ${widget.style === 'primary' ? 'selected' : ''}>Primary</option>
                        <option value="secondary" ${widget.style === 'secondary' ? 'selected' : ''}>Secondary</option>
                        <option value="success" ${widget.style === 'success' ? 'selected' : ''}>Success</option>
                        <option value="danger" ${widget.style === 'danger' ? 'selected' : ''}>Danger</option>
                        <option value="warning" ${widget.style === 'warning' ? 'selected' : ''}>Warning</option>
                        <option value="info" ${widget.style === 'info' ? 'selected' : ''}>Info</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Dropdown Items (2nd & 3rd Tier)</label>
                    <div id="dropdownItems">
                        ${dropdownItems.map((item, idx) => `
                            <div class="card mb-2" data-item-idx="${idx}">
                                <div class="card-body">
                                    <div class="d-flex gap-2 mb-2">
                                        <input type="text" class="form-control" placeholder="2nd tier text" value="${item.text}" data-idx="${idx}" data-field="text">
                                        <input type="text" class="form-control" placeholder="URL" value="${item.url}" data-idx="${idx}" data-field="url">
                                        <button class="btn btn-outline-danger" type="button" onclick="removeDropdownItem(${idx})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                    <div class="ms-3">
                                        <small class="text-muted">3rd Tier Items:</small>
                                        <div class="nested-items mt-2" data-parent-idx="${idx}">
                                            ${(item.nestedItems || []).map((nested, nIdx) => `
                                                <div class="input-group input-group-sm mb-1">
                                                    <input type="text" class="form-control" placeholder="3rd tier text" value="${nested.text}" data-parent="${idx}" data-nested-idx="${nIdx}" data-nested-field="text">
                                                    <input type="text" class="form-control" placeholder="URL" value="${nested.url}" data-parent="${idx}" data-nested-idx="${nIdx}" data-nested-field="url">
                                                    <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                </div>
                                            `).join('')}
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="addNestedItem(${idx})">
                                            <i class="bi bi-plus"></i> Add 3rd Tier Item
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="addDropdownItem()">
                        <i class="bi bi-plus"></i> Add 2nd Tier Dropdown Item
                    </button>
                </div>
            `;
            break;
        case 'link':
            const linkStyles = widget.styles || {};
            formHtml = `
                <div class="mb-3">
                    <label class="form-label">Link Text</label>
                    <input type="text" class="form-control" id="widgetText" value="${widget.text}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Link to Page (Optional)</label>
                    <select class="form-select" id="widgetPageSelect" onchange="selectPageForLink(this.value)">
                        <option value="">-- Select a page or enter custom URL --</option>
                        ${sitePages.map(p => `<option value="${p.id}">${p.title}</option>`).join('')}
                    </select>
                    <small class="text-muted">Select a page from this site, or enter a custom URL below</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">URL</label>
                    <input type="text" class="form-control" id="widgetUrl" value="${widget.url}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Target</label>
                    <select class="form-select" id="widgetTarget">
                        <option value="_self" ${widget.target === '_self' ? 'selected' : ''}>Same Window</option>
                        <option value="_blank" ${widget.target === '_blank' ? 'selected' : ''}>New Window</option>
                    </select>
                </div>
                <hr>
                <h6>Styles</h6>
                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="form-label">Text Color</label>
                        <input type="color" class="form-control form-control-color" id="widgetColor" value="${linkStyles.color || '#000000'}">
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label">Text Decoration</label>
                        <select class="form-select" id="widgetTextDecoration">
                            <option value="" ${!linkStyles.textDecoration ? 'selected' : ''}>Default</option>
                            <option value="none" ${linkStyles.textDecoration === 'none' ? 'selected' : ''}>None</option>
                            <option value="underline" ${linkStyles.textDecoration === 'underline' ? 'selected' : ''}>Underline</option>
                            <option value="line-through" ${linkStyles.textDecoration === 'line-through' ? 'selected' : ''}>Strikethrough</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="form-label">Font Weight</label>
                        <select class="form-select" id="widgetFontWeight">
                            <option value="" ${!linkStyles.fontWeight ? 'selected' : ''}>Default</option>
                            <option value="normal" ${linkStyles.fontWeight === 'normal' ? 'selected' : ''}>Normal</option>
                            <option value="bold" ${linkStyles.fontWeight === 'bold' ? 'selected' : ''}>Bold</option>
                        </select>
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label">Font Size</label>
                        <input type="text" class="form-control" id="widgetFontSize" value="${linkStyles.fontSize || ''}" placeholder="e.g., 16px, 1.2rem">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Dropdown Items (2nd & 3rd Tier)</label>
                    <div id="dropdownItems">
                        ${(widget.dropdownItems || []).map((item, idx) => `
                            <div class="card mb-2" data-item-idx="${idx}">
                                <div class="card-body">
                                    <div class="d-flex gap-2 mb-2">
                                        <input type="text" class="form-control" placeholder="2nd tier text" value="${item.text}" data-idx="${idx}" data-field="text">
                                        <input type="text" class="form-control" placeholder="URL" value="${item.url}" data-idx="${idx}" data-field="url">
                                        <button class="btn btn-outline-danger" type="button" onclick="removeDropdownItem(${idx})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                    <div class="ms-3">
                                        <small class="text-muted">3rd Tier Items:</small>
                                        <div class="nested-items mt-2" data-parent-idx="${idx}">
                                            ${(item.nestedItems || []).map((nested, nIdx) => `
                                                <div class="input-group input-group-sm mb-1">
                                                    <input type="text" class="form-control" placeholder="3rd tier text" value="${nested.text}" data-parent="${idx}" data-nested-idx="${nIdx}" data-nested-field="text">
                                                    <input type="text" class="form-control" placeholder="URL" value="${nested.url}" data-parent="${idx}" data-nested-idx="${nIdx}" data-nested-field="url">
                                                    <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                </div>
                                            `).join('')}
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="addNestedItem(${idx})">
                                            <i class="bi bi-plus"></i> Add 3rd Tier Item
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="addDropdownItem()">
                        <i class="bi bi-plus"></i> Add 2nd Tier Dropdown Item
                    </button>
                </div>
            `;
            break;
        case 'card':
            formHtml = `
                <div class="mb-3">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-control" id="widgetTitle" value="${widget.title}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Content</label>
                    <textarea class="form-control" id="widgetContent" rows="4">${widget.content}</textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Image URL (optional)</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="widgetImage" value="${widget.image || ''}">
                        <button class="btn btn-outline-secondary" type="button" onclick="openImageGallery('widgetImage')">
                            <i class="bi bi-images"></i> Browse Gallery
                        </button>
                    </div>
                </div>
            `;
            break;
        case 'alert':
            formHtml = `
                <div class="mb-3">
                    <label class="form-label">Message</label>
                    <textarea class="form-control" id="widgetContent" rows="3">${widget.content}</textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Style</label>
                    <select class="form-select" id="widgetStyle">
                        <option value="primary" ${widget.style === 'primary' ? 'selected' : ''}>Primary</option>
                        <option value="secondary" ${widget.style === 'secondary' ? 'selected' : ''}>Secondary</option>
                        <option value="success" ${widget.style === 'success' ? 'selected' : ''}>Success</option>
                        <option value="danger" ${widget.style === 'danger' ? 'selected' : ''}>Danger</option>
                        <option value="warning" ${widget.style === 'warning' ? 'selected' : ''}>Warning</option>
                        <option value="info" ${widget.style === 'info' ? 'selected' : ''}>Info</option>
                    </select>
                </div>
            `;
            break;
        case 'image':
            formHtml = `
                <div class="mb-3">
                    <label class="form-label">Image URL</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="widgetSrc" value="${widget.src}">
                        <button class="btn btn-outline-secondary" type="button" onclick="openImageGallery('widgetSrc')">
                            <i class="bi bi-images"></i> Browse Gallery
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Alt Text</label>
                    <input type="text" class="form-control" id="widgetAlt" value="${widget.alt}">
                </div>
            `;
            break;
        case 'video':
            formHtml = `
                <div class="mb-3">
                    <label class="form-label">Video URL (YouTube/Vimeo embed)</label>
                    <input type="text" class="form-control" id="widgetUrl" value="${widget.url || ''}">
                    <small class="text-muted">Use embed URLs like: https://www.youtube.com/embed/VIDEO_ID</small>
                </div>
            `;
            break;
        case 'accordion':
            formHtml = `
                <div class="mb-3">
                    <label class="form-label">Accordion Items</label>
                    <div id="accordionItemsContainer">
                        ${(widget.items || []).map((item, idx) => `
                            <div class="card mb-2">
                                <div class="card-body">
                                    <div class="mb-2">
                                        <input type="text" class="form-control accordion-item-title" placeholder="Title" value="${item.title}">
                                    </div>
                                    <div class="mb-2">
                                        <textarea class="form-control accordion-item-content" placeholder="Content" rows="2">${item.content}</textarea>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input accordion-item-expanded" ${item.expanded ? 'checked' : ''}>
                                        <label class="form-check-label">Expanded by default</label>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addAccordionItem()">Add Item</button>
                </div>
            `;
            break;
        case 'breadcrumb':
            formHtml = `
                <div class="mb-3">
                    <label class="form-label">Breadcrumb Items</label>
                    <div id="breadcrumbItemsContainer">
                        ${(widget.items || []).map((item, idx) => `
                            <div class="card mb-2">
                                <div class="card-body">
                                    <div class="mb-2">
                                        <input type="text" class="form-control breadcrumb-item-text" placeholder="Text" value="${item.text}">
                                    </div>
                                    <div class="mb-2">
                                        <input type="text" class="form-control breadcrumb-item-url" placeholder="URL" value="${item.url || ''}">
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input breadcrumb-item-active" ${item.active ? 'checked' : ''}>
                                        <label class="form-check-label">Active (current page)</label>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addBreadcrumbItem()">Add Item</button>
                </div>
            `;
            break;
        case 'collapse':
            formHtml = `
                <div class="mb-3">
                    <label class="form-label">Button Title</label>
                    <input type="text" class="form-control" id="widgetTitle" value="${widget.title}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Collapsed Content</label>
                    <textarea class="form-control" id="widgetContent" rows="4">${widget.content}</textarea>
                </div>
                <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="widgetExpanded" ${widget.expanded ? 'checked' : ''}>
                    <label class="form-check-label" for="widgetExpanded">Expanded by default</label>
                </div>
            `;
            break;
        case 'tabs':
            formHtml = `
                <div class="mb-3">
                    <label class="form-label">Tabs</label>
                    <div id="tabsContainer">
                        ${(widget.tabs || []).map((tab, idx) => `
                            <div class="card mb-2">
                                <div class="card-body">
                                    <div class="mb-2">
                                        <input type="text" class="form-control tab-title" placeholder="Tab Title" value="${tab.title}">
                                    </div>
                                    <div class="mb-2">
                                        <textarea class="form-control tab-content" placeholder="Tab Content" rows="2">${tab.content}</textarea>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input tab-active" ${tab.active ? 'checked' : ''}>
                                        <label class="form-check-label">Active tab</label>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addTab()">Add Tab</button>
                </div>
            `;
            break;
        case 'links':
            formHtml = `
                <div class="mb-3">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-control" id="widgetTitle" value="${widget.title}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Links</label>
                    <div id="linksList">
                        ${widget.links.map((link, i) => `
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" placeholder="Text" value="${link.text}" data-link-index="${i}" data-link-field="text">
                                <input type="text" class="form-control" placeholder="URL" value="${link.url}" data-link-index="${i}" data-link-field="url">
                                <button class="btn btn-outline-danger" type="button" onclick="removeLink(${i})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="addLink()">
                        <i class="bi bi-plus"></i> Add Link
                    </button>
                </div>
            `;
            break;
        case 'social':
            formHtml = `
                <div class="mb-3">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-control" id="widgetTitle" value="${widget.title}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Social Platforms</label>
                    <div id="platformsList">
                        ${widget.platforms.map((platform, i) => `
                            <div class="input-group mb-2">
                                <select class="form-select" data-platform-index="${i}" data-platform-field="icon">
                                    <option value="facebook" ${platform.icon === 'facebook' ? 'selected' : ''}>Facebook</option>
                                    <option value="twitter" ${platform.icon === 'twitter' ? 'selected' : ''}>Twitter</option>
                                    <option value="instagram" ${platform.icon === 'instagram' ? 'selected' : ''}>Instagram</option>
                                    <option value="linkedin" ${platform.icon === 'linkedin' ? 'selected' : ''}>LinkedIn</option>
                                    <option value="youtube" ${platform.icon === 'youtube' ? 'selected' : ''}>YouTube</option>
                                </select>
                                <input type="text" class="form-control" placeholder="URL" value="${platform.url}" data-platform-index="${i}" data-platform-field="url">
                                <button class="btn btn-outline-danger" type="button" onclick="removePlatform(${i})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="addPlatform()">
                        <i class="bi bi-plus"></i> Add Platform
                    </button>
                </div>
            `;
            break;
        case 'copyright':
            formHtml = `
                <div class="mb-3">
                    <label class="form-label">Copyright Text</label>
                    <input type="text" class="form-control" id="widgetText" value="${widget.text}">
                </div>
            `;
            break;
        case 'caspio':
            formHtml = `
                <div class="mb-3">
                    <label class="form-label">DataPage Name</label>
                    <input type="text" class="form-control" id="widgetDatapageName" value="${widget.datapageName || ''}" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">App Name</label>
                    <input type="text" class="form-control" id="widgetAppName" value="${widget.appName || ''}" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">DataPage Key</label>
                    <input type="text" class="form-control" id="widgetDatapageKey" value="${widget.datapageKey || ''}" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">Deploy URL</label>
                    <input type="text" class="form-control" id="widgetDeployUrl" value="${widget.deployUrl || ''}" readonly>
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Caspio DataPage properties are read-only. To change the DataPage, delete this widget and drag a different one from the Caspio sidebar.
                </div>
            `;
            break;
    }
    return formHtml;
}

function editWidget(widgetId) {
    const widget = findWidgetById(widgetId);
    if (!widget) return;

    currentEditingWidget = widget;
    document.getElementById('widgetModalTitle').textContent = `Edit ${widget.type.charAt(0).toUpperCase() + widget.type.slice(1)}`;
    document.getElementById('widgetModalBody').innerHTML = getWidgetFormHtml(widget);
    widgetModal.show();
}

function saveWidgetEdit() {
    if (!currentEditingWidget) return;

    const widget = currentEditingWidget;

    // Handle row editing
    if (widget._rowIndex !== undefined && widget.type === 'row') {
        const numCols = parseInt(document.getElementById('rowNumColumns').value);
        widgets[widget._rowIndex].numColumns = numCols;
        renderWidgets();
        widgetModal.hide();
        currentEditingWidget = null;
        return;
    }

    // Handle column editing
    if (widget._isColumn) {
        const width = parseInt(document.getElementById('columnWidth').value);
        widgets[widget._rowIndex].children[widget._colIndex].width = width;
        renderWidgets();
        widgetModal.hide();
        currentEditingWidget = null;
        return;
    }

    switch(widget.type) {
        case 'heading':
            widget.content = document.getElementById('widgetContent').value;
            widget.level = document.getElementById('widgetLevel').value;
            break;
        case 'text':
            widget.content = document.getElementById('widgetContent').value;
            break;
        case 'richtext':
            widget.content = document.getElementById('widgetContent').value;
            break;
        case 'html':
            widget.content = document.getElementById('widgetContent').value;
            break;
        case 'separator':
            // No editable properties for separator
            break;
        case 'button':
            widget.text = document.getElementById('widgetText').value;
            widget.url = document.getElementById('widgetUrl').value;
            widget.style = document.getElementById('widgetStyle').value;

            // Collect dropdown items with nested items
            const buttonDropdownItems = [];
            const buttonMainInputs = document.querySelectorAll('#dropdownItems input[data-idx]');
            const buttonItemsMap = {};

            // Collect 2nd tier items
            buttonMainInputs.forEach(input => {
                const idx = input.dataset.idx;
                const field = input.dataset.field;
                if (!buttonItemsMap[idx]) buttonItemsMap[idx] = { nestedItems: [] };
                buttonItemsMap[idx][field] = input.value;
            });

            // Collect 3rd tier nested items
            const buttonNestedInputs = document.querySelectorAll('#dropdownItems input[data-nested-idx]');
            const buttonNestedMap = {};

            buttonNestedInputs.forEach(input => {
                const parent = input.dataset.parent;
                const nIdx = input.dataset.nestedIdx;
                const field = input.dataset.nestedField;
                const key = `${parent}-${nIdx}`;
                if (!buttonNestedMap[key]) buttonNestedMap[key] = { parent: parent };
                buttonNestedMap[key][field] = input.value;
            });

            // Organize nested items into their parent items
            Object.values(buttonNestedMap).forEach(nested => {
                const parentIdx = nested.parent;
                if (buttonItemsMap[parentIdx]) {
                    buttonItemsMap[parentIdx].nestedItems.push({
                        text: nested.text,
                        url: nested.url
                    });
                }
            });

            // Build final dropdown items array
            Object.values(buttonItemsMap).forEach(item => {
                if (item.text && item.url) {
                    buttonDropdownItems.push({
                        text: item.text,
                        url: item.url,
                        nestedItems: item.nestedItems.filter(n => n.text && n.url)
                    });
                }
            });

            widget.dropdownItems = buttonDropdownItems;
            break;
        case 'link':
            widget.text = document.getElementById('widgetText').value;
            widget.url = document.getElementById('widgetUrl').value;
            widget.target = document.getElementById('widgetTarget').value;

            // Collect dropdown items with nested items
            const dropdownItems = [];
            const mainInputs = document.querySelectorAll('#dropdownItems input[data-idx]');
            const itemsMap = {};

            // Collect 2nd tier items
            mainInputs.forEach(input => {
                const idx = input.dataset.idx;
                const field = input.dataset.field;
                if (!itemsMap[idx]) itemsMap[idx] = { nestedItems: [] };
                itemsMap[idx][field] = input.value;
            });

            // Collect 3rd tier nested items
            const nestedInputs = document.querySelectorAll('#dropdownItems input[data-nested-idx]');
            const nestedMap = {};

            nestedInputs.forEach(input => {
                const parent = input.dataset.parent;
                const nIdx = input.dataset.nestedIdx;
                const field = input.dataset.nestedField;
                const key = `${parent}-${nIdx}`;
                if (!nestedMap[key]) nestedMap[key] = { parent: parent };
                nestedMap[key][field] = input.value;
            });

            // Organize nested items into their parent items
            Object.values(nestedMap).forEach(nested => {
                const parentIdx = nested.parent;
                if (itemsMap[parentIdx]) {
                    itemsMap[parentIdx].nestedItems.push({
                        text: nested.text,
                        url: nested.url
                    });
                }
            });

            // Build final dropdown items array
            Object.values(itemsMap).forEach(item => {
                if (item.text && item.url) {
                    dropdownItems.push({
                        text: item.text,
                        url: item.url,
                        nestedItems: item.nestedItems.filter(n => n.text && n.url)
                    });
                }
            });

            widget.dropdownItems = dropdownItems;

            // Save link styles
            if (!widget.styles) widget.styles = {};
            const colorEl = document.getElementById('widgetColor');
            const textDecEl = document.getElementById('widgetTextDecoration');
            const fontWeightEl = document.getElementById('widgetFontWeight');
            const fontSizeEl = document.getElementById('widgetFontSize');

            if (colorEl && colorEl.value && colorEl.value !== '#000000') {
                widget.styles.color = colorEl.value;
            } else if (colorEl && colorEl.value === '#000000') {
                // Keep black color if explicitly set (check if user interacted with it)
                widget.styles.color = colorEl.value;
            }
            if (textDecEl && textDecEl.value) widget.styles.textDecoration = textDecEl.value;
            if (fontWeightEl && fontWeightEl.value) widget.styles.fontWeight = fontWeightEl.value;
            if (fontSizeEl && fontSizeEl.value) widget.styles.fontSize = fontSizeEl.value;
            break;
        case 'card':
            widget.title = document.getElementById('widgetTitle').value;
            widget.content = document.getElementById('widgetContent').value;
            widget.image = document.getElementById('widgetImage').value;
            break;
        case 'alert':
            widget.content = document.getElementById('widgetContent').value;
            widget.style = document.getElementById('widgetStyle').value;
            break;
        case 'image':
            widget.src = document.getElementById('widgetSrc').value;
            widget.alt = document.getElementById('widgetAlt').value;
            break;
        case 'video':
            widget.url = document.getElementById('widgetUrl').value;
            break;
        case 'accordion':
            const items = [];
            document.querySelectorAll('#accordionItemsContainer .card').forEach((card) => {
                items.push({
                    title: card.querySelector('.accordion-item-title').value,
                    content: card.querySelector('.accordion-item-content').value,
                    expanded: card.querySelector('.accordion-item-expanded').checked
                });
            });
            widget.items = items;
            break;
        case 'breadcrumb':
            const breadcrumbItems = [];
            document.querySelectorAll('#breadcrumbItemsContainer .card').forEach((card) => {
                breadcrumbItems.push({
                    text: card.querySelector('.breadcrumb-item-text').value,
                    url: card.querySelector('.breadcrumb-item-url').value,
                    active: card.querySelector('.breadcrumb-item-active').checked
                });
            });
            widget.items = breadcrumbItems;
            break;
        case 'collapse':
            widget.title = document.getElementById('widgetTitle').value;
            widget.content = document.getElementById('widgetContent').value;
            widget.expanded = document.getElementById('widgetExpanded').checked;
            break;
        case 'tabs':
            const tabs = [];
            document.querySelectorAll('#tabsContainer .card').forEach((card) => {
                tabs.push({
                    title: card.querySelector('.tab-title').value,
                    content: card.querySelector('.tab-content').value,
                    active: card.querySelector('.tab-active').checked
                });
            });
            widget.tabs = tabs;
            break;
        case 'links':
            widget.title = document.getElementById('widgetTitle').value;
            widget.links = Array.from(document.querySelectorAll('[data-link-index]'))
                .reduce((acc, el) => {
                    const index = parseInt(el.dataset.linkIndex);
                    const field = el.dataset.linkField;
                    if (!acc[index]) acc[index] = {};
                    acc[index][field] = el.value;
                    return acc;
                }, []).filter(link => link.text && link.url);
            break;
        case 'social':
            widget.title = document.getElementById('widgetTitle').value;
            widget.platforms = Array.from(document.querySelectorAll('[data-platform-index]'))
                .reduce((acc, el) => {
                    const index = parseInt(el.dataset.platformIndex);
                    const field = el.dataset.platformField;
                    if (!acc[index]) acc[index] = {};
                    acc[index][field] = el.value;
                    return acc;
                }, []).filter(platform => platform.icon && platform.url);
            break;
        case 'copyright':
            widget.text = document.getElementById('widgetText').value;
            break;
        case 'caspio':
            // Caspio properties are read-only, nothing to update
            break;
    }

    renderWidgets();
    widgetModal.hide();
    currentEditingWidget = null;
}

function deleteWidget(widgetId) {
    if (!confirm('Delete this widget?')) return;
    widgets = widgets.filter(w => w.id !== widgetId && w.id != widgetId);
    renderWidgets();
}

function deleteNestedWidget(rowIndex, colIndex, childIndex) {
    if (!confirm('Delete this widget?')) return;
    if (widgets[rowIndex] && widgets[rowIndex].type === 'row') {
        widgets[rowIndex].children[colIndex].children.splice(childIndex, 1);
        renderWidgets();
    }
}

function editRow(rowIndex) {
    const row = widgets[rowIndex];
    if (!row || row.type !== 'row') return;

    const formHtml = `
        <div class="mb-3">
            <label class="form-label">Number of Columns</label>
            <select class="form-select" id="rowNumColumns">
                <option value="1" ${row.numColumns === 1 ? 'selected' : ''}>1 Column</option>
                <option value="2" ${row.numColumns === 2 ? 'selected' : ''}>2 Columns</option>
                <option value="3" ${row.numColumns === 3 ? 'selected' : ''}>3 Columns</option>
                <option value="4" ${row.numColumns === 4 ? 'selected' : ''}>4 Columns</option>
                <option value="6" ${row.numColumns === 6 ? 'selected' : ''}>6 Columns</option>
            </select>
        </div>
    `;

    document.getElementById('widgetModalTitle').textContent = 'Edit Row';
    document.getElementById('widgetModalBody').innerHTML = formHtml;

    // Store row index for saving
    currentEditingWidget = { ...row, _rowIndex: rowIndex };
    widgetModal.show();
}

function editColumn(rowIndex, colIndex) {
    const row = widgets[rowIndex];
    if (!row || row.type !== 'row') return;
    const column = row.children[colIndex];
    if (!column) return;

    const formHtml = `
        <div class="mb-3">
            <label class="form-label">Column Width (out of 12)</label>
            <select class="form-select" id="columnWidth">
                <option value="1" ${column.width === 1 ? 'selected' : ''}>1/12</option>
                <option value="2" ${column.width === 2 ? 'selected' : ''}>2/12</option>
                <option value="3" ${column.width === 3 ? 'selected' : ''}>3/12 (Quarter)</option>
                <option value="4" ${column.width === 4 ? 'selected' : ''}>4/12 (Third)</option>
                <option value="5" ${column.width === 5 ? 'selected' : ''}>5/12</option>
                <option value="6" ${column.width === 6 ? 'selected' : ''}>6/12 (Half)</option>
                <option value="7" ${column.width === 7 ? 'selected' : ''}>7/12</option>
                <option value="8" ${column.width === 8 ? 'selected' : ''}>8/12 (Two-Thirds)</option>
                <option value="9" ${column.width === 9 ? 'selected' : ''}>9/12 (Three-Quarters)</option>
                <option value="10" ${column.width === 10 ? 'selected' : ''}>10/12</option>
                <option value="11" ${column.width === 11 ? 'selected' : ''}>11/12</option>
                <option value="12" ${column.width === 12 ? 'selected' : ''}>12/12 (Full)</option>
            </select>
        </div>
    `;

    document.getElementById('widgetModalTitle').textContent = `Edit Column ${colIndex + 1}`;
    document.getElementById('widgetModalBody').innerHTML = formHtml;

    // Store column info for saving
    currentEditingWidget = { ...column, _rowIndex: rowIndex, _colIndex: colIndex, _isColumn: true };
    widgetModal.show();
}

function editNestedWidget(rowIndex, colIndex, childIndex) {
    const row = widgets[rowIndex];
    if (!row || row.type !== 'row') return;
    const column = row.children[colIndex];
    if (!column || !column.children) return;
    const widget = column.children[childIndex];
    if (!widget) return;

    // Store location info
    currentEditingWidget = widget;
    currentEditingWidget._rowIndex = rowIndex;
    currentEditingWidget._colIndex = colIndex;
    currentEditingWidget._childIndex = childIndex;

    // Reuse the existing editWidget logic
    document.getElementById('widgetModalTitle').textContent = `Edit ${widget.type.charAt(0).toUpperCase() + widget.type.slice(1)}`;
    showWidgetEditForm(widget);
    widgetModal.show();
}

function showWidgetEditForm(widget) {
    let formHtml = getWidgetFormHtml(widget);
    document.getElementById('widgetModalBody').innerHTML = formHtml;
}

function updateWidgetOrder() {
    const canvas = document.getElementById('footerCanvas');
    const elements = canvas.querySelectorAll(':scope > .row-container, :scope > .widget-block.top-level');
    const newOrder = [];

    elements.forEach((el) => {
        const index = parseInt(el.dataset.index);
        if (index >= 0 && index < widgets.length) {
            newOrder.push(widgets[index]);
        }
    });

    widgets.length = 0;
    widgets.push(...newOrder);

    // Re-render to update indices
    renderWidgets();
}

function updateColumnWidgetOrder(evt) {
    const item = evt.item;
    const from = evt.from;
    const to = evt.to;

    // Get source and target column info
    const fromRow = parseInt(from.dataset.dropRow);
    const fromCol = parseInt(from.dataset.dropCol);
    const toRow = parseInt(to.dataset.dropRow);
    const toCol = parseInt(to.dataset.dropCol);

    if (isNaN(fromRow) || isNaN(fromCol) || isNaN(toRow) || isNaN(toCol)) return;

    // Get the old and new indices
    const oldIndex = evt.oldIndex;
    const newIndex = evt.newIndex;

    // Same column - just reorder
    if (fromRow === toRow && fromCol === toCol) {
        const column = widgets[fromRow].children[fromCol];
        const movedWidget = column.children.splice(oldIndex, 1)[0];
        column.children.splice(newIndex, 0, movedWidget);
    } else {
        // Moving between columns
        const sourceColumn = widgets[fromRow].children[fromCol];
        const targetColumn = widgets[toRow].children[toCol];
        const movedWidget = sourceColumn.children.splice(oldIndex, 1)[0];
        targetColumn.children.splice(newIndex, 0, movedWidget);
    }

    renderWidgets();
}

function addLink() {
    const list = document.getElementById('linksList');
    const index = list.querySelectorAll('.input-group').length;
    const html = `
        <div class="input-group mb-2">
            <input type="text" class="form-control" placeholder="Text" value="" data-link-index="${index}" data-link-field="text">
            <input type="text" class="form-control" placeholder="URL" value="" data-link-index="${index}" data-link-field="url">
            <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;
    list.insertAdjacentHTML('beforeend', html);
}

function removeLink(index) {
    event.target.closest('.input-group').remove();
}

function addPlatform() {
    const list = document.getElementById('platformsList');
    const index = list.querySelectorAll('.input-group').length;
    const html = `
        <div class="input-group mb-2">
            <select class="form-select" data-platform-index="${index}" data-platform-field="icon">
                <option value="facebook">Facebook</option>
                <option value="twitter">Twitter</option>
                <option value="instagram">Instagram</option>
                <option value="linkedin">LinkedIn</option>
                <option value="youtube">YouTube</option>
            </select>
            <input type="text" class="form-control" placeholder="URL" value="" data-platform-index="${index}" data-platform-field="url">
            <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;
    list.insertAdjacentHTML('beforeend', html);
}

function removePlatform(index) {
    event.target.closest('.input-group').remove();
}

function addDropdownItem() {
    const container = document.getElementById('dropdownItems');
    const currentCards = container.querySelectorAll('.card');
    const idx = currentCards.length;

    const newCard = document.createElement('div');
    newCard.className = 'card mb-2';
    newCard.setAttribute('data-item-idx', idx);
    newCard.innerHTML = `
        <div class="card-body">
            <div class="d-flex gap-2 mb-2">
                <input type="text" class="form-control" placeholder="2nd tier text" value="" data-idx="${idx}" data-field="text">
                <input type="text" class="form-control" placeholder="URL" value="" data-idx="${idx}" data-field="url">
                <button class="btn btn-outline-danger" type="button" onclick="removeDropdownItem(${idx})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            <div class="ms-3">
                <small class="text-muted">3rd Tier Items:</small>
                <div class="nested-items mt-2" data-parent-idx="${idx}">
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="addNestedItem(${idx})">
                    <i class="bi bi-plus"></i> Add 3rd Tier Item
                </button>
            </div>
        </div>
    `;
    container.appendChild(newCard);
}

function removeDropdownItem(idx) {
    const card = document.querySelector(`#dropdownItems .card[data-item-idx="${idx}"]`);
    card?.remove();
}

function addNestedItem(parentIdx) {
    const container = document.querySelector(`.nested-items[data-parent-idx="${parentIdx}"]`);
    const currentNested = container.querySelectorAll('.input-group');
    const nIdx = currentNested.length;

    const newNested = document.createElement('div');
    newNested.className = 'input-group input-group-sm mb-1';
    newNested.innerHTML = `
        <input type="text" class="form-control" placeholder="3rd tier text" value="" data-parent="${parentIdx}" data-nested-idx="${nIdx}" data-nested-field="text">
        <input type="text" class="form-control" placeholder="URL" value="" data-parent="${parentIdx}" data-nested-idx="${nIdx}" data-nested-field="url">
        <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">
            <i class="bi bi-x"></i>
        </button>
    `;
    container.appendChild(newNested);
}

function selectPageForLink(pageId) {
    if (!pageId) return;

    const selectedPage = sitePages.find(p => p.id == pageId);
    if (selectedPage) {
        const urlInput = document.getElementById('widgetUrl');
        if (urlInput) {
            // Use full_path for nested pages
            urlInput.value = `/site/${siteId}/${selectedPage.full_path || selectedPage.slug}`;
        }
    }
}

function openImageGallery(inputId) {
    currentImageInputId = inputId;
    loadGalleryImages();
    imageGalleryModal.show();
}

function loadGalleryImages() {
    const loading = document.getElementById('galleryLoading');
    const grid = document.getElementById('galleryGrid');
    const empty = document.getElementById('galleryEmpty');

    loading.style.display = 'block';
    grid.style.display = 'none';
    empty.style.display = 'none';

    fetch('/api/images/list')
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';

            if (data.success && data.images.length > 0) {
                grid.innerHTML = data.images.map(img => `
                    <div class="col-md-3 col-sm-4 col-6">
                        <div class="card h-100" style="cursor: pointer;" onclick="selectImage('${img.url}')">
                            <img src="${img.url}" class="card-img-top" alt="${img.filename}" style="height: 200px; object-fit: cover;">
                            <div class="card-body p-2">
                                <small class="text-muted text-truncate d-block">${img.filename}</small>
                            </div>
                        </div>
                    </div>
                `).join('');
                grid.style.display = 'flex';
            } else {
                empty.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading images:', error);
            loading.style.display = 'none';
            empty.style.display = 'block';
        });
}

function selectImage(url) {
    if (currentImageInputId) {
        const input = document.getElementById(currentImageInputId);
        if (input) {
            input.value = url;
        }
    }
    imageGalleryModal.hide();
}

function uploadToGallery() {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];

    if (!file) {
        alert('Please select a file');
        return;
    }

    const formData = new FormData();
    formData.append('file', file);

    const progressDiv = document.getElementById('uploadProgress');
    progressDiv.style.display = 'block';

    fetch('/api/upload', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken()
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        progressDiv.style.display = 'none';

        if (data.success) {
            // Switch to browse tab and reload images
            const browseTab = new bootstrap.Tab(document.getElementById('browse-tab'));
            browseTab.show();
            loadGalleryImages();

            // Auto-select the uploaded image
            if (currentImageInputId) {
                const input = document.getElementById(currentImageInputId);
                if (input) {
                    input.value = data.url;
                }
            }

            // Reset form
            fileInput.value = '';
            alert('Image uploaded successfully!');
        } else {
            alert('Upload failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        progressDiv.style.display = 'none';
        console.error('Error uploading file:', error);
        alert('Upload failed');
    });
}

function saveFooter() {
    const name = document.getElementById('footerName').value;
    const isActive = document.getElementById('footerActive').checked;

    fetch('/footer/{{ footer.id }}/save', {
        method: 'POST',
        headers: getHeaders(),
        body: JSON.stringify({
            name: name,
            is_active: isActive,
            content: widgets
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Footer saved successfully!');
            window.location.href = '/site/{{ site.id }}';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save footer');
    });
}

function addAccordionItem() {
    const container = document.getElementById('accordionItemsContainer');
    const newItem = document.createElement('div');
    newItem.className = 'card mb-2';
    newItem.innerHTML = `
        <div class="card-body">
            <div class="mb-2">
                <input type="text" class="form-control accordion-item-title" placeholder="Title" value="New Item">
            </div>
            <div class="mb-2">
                <textarea class="form-control accordion-item-content" placeholder="Content" rows="2">Content here...</textarea>
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input accordion-item-expanded">
                <label class="form-check-label">Expanded by default</label>
            </div>
        </div>
    `;
    container.appendChild(newItem);
}

function addBreadcrumbItem() {
    const container = document.getElementById('breadcrumbItemsContainer');
    const newItem = document.createElement('div');
    newItem.className = 'card mb-2';
    newItem.innerHTML = `
        <div class="card-body">
            <div class="mb-2">
                <input type="text" class="form-control breadcrumb-item-text" placeholder="Text" value="New Item">
            </div>
            <div class="mb-2">
                <input type="text" class="form-control breadcrumb-item-url" placeholder="URL" value="#">
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input breadcrumb-item-active">
                <label class="form-check-label">Active (current page)</label>
            </div>
        </div>
    `;
    container.appendChild(newItem);
}

function addTab() {
    const container = document.getElementById('tabsContainer');
    const newTab = document.createElement('div');
    newTab.className = 'card mb-2';
    newTab.innerHTML = `
        <div class="card-body">
            <div class="mb-2">
                <input type="text" class="form-control tab-title" placeholder="Tab Title" value="New Tab">
            </div>
            <div class="mb-2">
                <textarea class="form-control tab-content" placeholder="Tab Content" rows="2">Content here...</textarea>
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input tab-active">
                <label class="form-check-label">Active tab</label>
            </div>
        </div>
    `;
    container.appendChild(newTab);
}

function editFooterStyles() {
    if (!footerStyles) footerStyles = {};

    document.getElementById('widgetModalTitle').textContent = 'Footer Styling';
    document.getElementById('widgetModalBody').innerHTML = `
        <h6 class="mb-2">Colors</h6>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">Text Color</label>
                <input type="color" class="form-control form-control-color" id="footerTextColor" value="${footerStyles.color || '#ffffff'}">
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Link Color</label>
                <input type="color" class="form-control form-control-color" id="footerLinkColor" value="${footerStyles.linkColor || '#adb5bd'}">
                <small class="text-muted">Applies to all links</small>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Background Color</label>
                <div class="d-flex align-items-center gap-2">
                    <input type="color" class="form-control form-control-color" id="footerBgColor" value="${footerStyles.backgroundColor && footerStyles.backgroundColor !== 'transparent' ? footerStyles.backgroundColor : '#212529'}" ${!footerStyles.backgroundColor || footerStyles.backgroundColor === 'transparent' ? 'disabled' : ''}>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="footerBgTransparent" ${!footerStyles.backgroundColor || footerStyles.backgroundColor === 'transparent' ? 'checked' : ''} onchange="document.getElementById('footerBgColor').disabled = this.checked">
                        <label class="form-check-label" for="footerBgTransparent">Transparent</label>
                    </div>
                </div>
            </div>
        </div>

        <h6 class="mt-3 mb-2">Background Media</h6>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Background Image URL</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="footerBgImage" value="${footerStyles.backgroundImage || ''}" placeholder="https://...">
                    <button class="btn btn-outline-secondary" type="button" onclick="openImageGallery('footerBgImage')">
                        <i class="bi bi-images"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Background Size</label>
                <select class="form-select" id="footerBgSize">
                    <option value="cover" ${(footerStyles.backgroundSize || 'cover') === 'cover' ? 'selected' : ''}>Cover</option>
                    <option value="contain" ${footerStyles.backgroundSize === 'contain' ? 'selected' : ''}>Contain</option>
                    <option value="auto" ${footerStyles.backgroundSize === 'auto' ? 'selected' : ''}>Auto</option>
                </select>
            </div>
        </div>

        <h6 class="mt-3 mb-2">Borders</h6>
        <div class="row">
            <div class="col-md-3 mb-2">
                <label class="form-label small">Top</label>
                <input type="text" class="form-control form-control-sm" id="footerBorderTop" value="${footerStyles.borderTop || ''}" placeholder="e.g. 1px solid #000">
            </div>
            <div class="col-md-3 mb-2">
                <label class="form-label small">Right</label>
                <input type="text" class="form-control form-control-sm" id="footerBorderRight" value="${footerStyles.borderRight || ''}" placeholder="e.g. 1px solid #000">
            </div>
            <div class="col-md-3 mb-2">
                <label class="form-label small">Bottom</label>
                <input type="text" class="form-control form-control-sm" id="footerBorderBottom" value="${footerStyles.borderBottom || ''}" placeholder="e.g. 1px solid #000">
            </div>
            <div class="col-md-3 mb-2">
                <label class="form-label small">Left</label>
                <input type="text" class="form-control form-control-sm" id="footerBorderLeft" value="${footerStyles.borderLeft || ''}" placeholder="e.g. 1px solid #000">
            </div>
        </div>

        <h6 class="mt-3 mb-2">Spacing</h6>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Padding</label>
                <input type="text" class="form-control" id="footerPadding" value="${footerStyles.padding || ''}" placeholder="e.g. 2rem or 20px 40px">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Margin</label>
                <input type="text" class="form-control" id="footerMargin" value="${footerStyles.margin || ''}" placeholder="e.g. 0 auto">
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Custom CSS</label>
            <textarea class="form-control" id="footerCustomCss" rows="3" placeholder="Additional CSS properties">${footerStyles.custom || ''}</textarea>
            <small class="text-muted">Enter custom CSS properties like: font-family: Arial;</small>
        </div>
    `;

    const saveBtn = document.querySelector('#widgetModal .btn-primary');
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    newSaveBtn.onclick = saveFooterStylesEdit;

    widgetModal.show();
}

function saveFooterStylesEdit() {
    // Colors
    const bgTransparent = document.getElementById('footerBgTransparent').checked;
    footerStyles.backgroundColor = bgTransparent ? 'transparent' : document.getElementById('footerBgColor').value;
    footerStyles.color = document.getElementById('footerTextColor').value;
    footerStyles.linkColor = document.getElementById('footerLinkColor').value;

    // Background media
    footerStyles.backgroundImage = document.getElementById('footerBgImage').value;
    footerStyles.backgroundSize = document.getElementById('footerBgSize').value;

    // Borders
    footerStyles.borderTop = document.getElementById('footerBorderTop').value;
    footerStyles.borderRight = document.getElementById('footerBorderRight').value;
    footerStyles.borderBottom = document.getElementById('footerBorderBottom').value;
    footerStyles.borderLeft = document.getElementById('footerBorderLeft').value;

    // Spacing
    footerStyles.padding = document.getElementById('footerPadding').value;
    footerStyles.margin = document.getElementById('footerMargin').value;

    // Custom CSS
    footerStyles.custom = document.getElementById('footerCustomCss').value;

    widgetModal.hide();

    const saveBtn = document.querySelector('#widgetModal .btn-primary');
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    newSaveBtn.onclick = saveWidgetEdit;

    // Auto-save footer styles to database
    fetch(`/footer/${footerId}/save`, {
        method: 'POST',
        headers: getHeaders(),
        body: JSON.stringify({
            footer_styles: footerStyles
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Footer styles saved successfully');
        } else {
            console.error('Failed to save footer styles');
        }
    })
    .catch(error => {
        console.error('Error saving footer styles:', error);
    });
}

// Caspio DataPages Integration
function loadCaspioDatapages() {
    const sidebarContent = document.getElementById('caspioSidebarContent');
    if (!sidebarContent) return;

    sidebarContent.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2 small text-muted">Loading DataPages...</div>
        </div>
    `;

    fetch('/api/caspio/datapages')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                sidebarContent.innerHTML = `
                    <div class="alert alert-warning m-2 small">
                        <i class="bi bi-exclamation-triangle"></i> ${data.error}
                    </div>
                `;
            } else if (!data.configured) {
                sidebarContent.innerHTML = `
                    <div class="alert alert-info m-2 small">
                        <i class="bi bi-info-circle"></i> Caspio not configured. Add credentials to .env file.
                    </div>
                `;
            } else {
                renderCaspioSidebar(data.apps || []);
            }
        })
        .catch(error => {
            console.error('Error loading Caspio datapages:', error);
            sidebarContent.innerHTML = `
                <div class="alert alert-danger m-2 small">
                    <i class="bi bi-x-circle"></i> Failed to load DataPages
                </div>
            `;
        });
}

function renderCaspioSidebar(apps) {
    const sidebarContent = document.getElementById('caspioSidebarContent');
    if (!sidebarContent) return;

    if (apps.length === 0) {
        sidebarContent.innerHTML = `
            <div class="alert alert-info m-2 small">
                <i class="bi bi-info-circle"></i> No DataPages found in your Caspio account.
            </div>
        `;
        return;
    }

    let html = '';

    apps.forEach((app, appIndex) => {
        const appDatapages = app.datapages || [];
        const appFolders = app.folders || [];
        const totalCount = appDatapages.length + appFolders.reduce((sum, f) => sum + (f.datapages || []).length, 0);

        html += `
            <div class="caspio-app-group">
                <div class="caspio-app-header" onclick="toggleCaspioApp(${appIndex})">
                    <i class="bi bi-chevron-right me-1 toggle-icon" id="appToggle${appIndex}"></i>
                    <i class="bi bi-app me-1"></i>
                    <span class="flex-grow-1">${app.name}</span>
                    <span class="badge bg-secondary">${totalCount}</span>
                </div>
                <div class="caspio-app-content" id="appContent${appIndex}" style="display: none;">
        `;

        // Root-level datapages (no folder)
        appDatapages.forEach(dp => {
            html += `
                <div class="caspio-datapage-item" draggable="true"
                    data-datapage-name="${dp.name}"
                    data-datapage-key="${dp.key}"
                    data-app-name="${app.name}"
                    data-deploy-url="${dp.deployUrl || ''}">
                    <i class="bi bi-file-earmark-code me-1"></i>
                    ${dp.name}
                </div>
            `;
        });

        // Folders with their datapages
        appFolders.forEach((folder, folderIndex) => {
            const folderDatapages = folder.datapages || [];
            html += `
                <div class="caspio-folder-group">
                    <div class="caspio-folder-header" onclick="toggleCaspioFolder(${appIndex}, ${folderIndex})">
                        <i class="bi bi-chevron-right me-1 toggle-icon" id="folderToggle${appIndex}_${folderIndex}"></i>
                        <i class="bi bi-folder me-1"></i>
                        <span class="flex-grow-1">${folder.name}</span>
                        <span class="badge bg-secondary">${folderDatapages.length}</span>
                    </div>
                    <div class="caspio-folder-content" id="folderContent${appIndex}_${folderIndex}" style="display: none;">
            `;

            folderDatapages.forEach(dp => {
                html += `
                    <div class="caspio-datapage-item" draggable="true"
                        data-datapage-name="${dp.name}"
                        data-datapage-key="${dp.key}"
                        data-app-name="${app.name}"
                        data-deploy-url="${dp.deployUrl || ''}">
                        <i class="bi bi-file-earmark-code me-1"></i>
                        ${dp.name}
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;
        });

        html += `
                </div>
            </div>
        `;
    });

    sidebarContent.innerHTML = html;
    setupCaspioDragHandlers();
}

function setupCaspioDragHandlers() {
    document.querySelectorAll('.caspio-datapage-item').forEach(item => {
        item.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('widgetType', 'caspio');
            e.dataTransfer.setData('caspioDatapageName', item.dataset.datapageName);
            e.dataTransfer.setData('caspioDatapageKey', item.dataset.datapageKey);
            e.dataTransfer.setData('caspioAppName', item.dataset.appName);
            e.dataTransfer.setData('caspioDeployUrl', item.dataset.deployUrl || '');
            e.dataTransfer.effectAllowed = 'copy';
        });
    });
}

function toggleCaspioApp(appIndex) {
    const content = document.getElementById(`appContent${appIndex}`);
    const toggle = document.getElementById(`appToggle${appIndex}`);
    if (content && toggle) {
        if (content.style.display === 'none') {
            content.style.display = 'block';
            toggle.classList.remove('bi-chevron-right');
            toggle.classList.add('bi-chevron-down');
        } else {
            content.style.display = 'none';
            toggle.classList.remove('bi-chevron-down');
            toggle.classList.add('bi-chevron-right');
        }
    }
}

function toggleCaspioFolder(appIndex, folderIndex) {
    const content = document.getElementById(`folderContent${appIndex}_${folderIndex}`);
    const toggle = document.getElementById(`folderToggle${appIndex}_${folderIndex}`);
    if (content && toggle) {
        if (content.style.display === 'none') {
            content.style.display = 'block';
            toggle.classList.remove('bi-chevron-right');
            toggle.classList.add('bi-chevron-down');
        } else {
            content.style.display = 'none';
            toggle.classList.remove('bi-chevron-down');
            toggle.classList.add('bi-chevron-right');
        }
    }
}

function refreshCaspioDatapages() {
    loadCaspioDatapages();
}
</script>
{% endblock %}
