{% extends "base.html" %}

{% block title %}Edit {{ menu.name }} - Menu Builder{% endblock %}

{% block body %}
<div class="cms-container">
    <nav class="cms-sidebar">
        <div class="sidebar-header">
            <h4><i class="bi bi-compass"></i> CMS Builder</h4>
        </div>
        <ul class="sidebar-menu">
            <li><a href="/"><i class="bi bi-grid"></i> Dashboard</a></li>
            <li><a href="/site/{{ site.id }}"><i class="bi bi-globe"></i> {{ site.name }}</a></li>
        </ul>
    </nav>

    <main class="cms-main">
        <div class="cms-header">
            <div>
                <h1>Edit Menu: {{ menu.name }}</h1>
                <p class="text-muted">Configure menu items and position</p>
            </div>
            <div>
                <a href="/site/{{ site.id }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Site
                </a>
                <button class="btn btn-primary" onclick="saveMenu()">
                    <i class="bi bi-save"></i> Save Menu
                </button>
            </div>
        </div>

        <div class="cms-content">
            <div class="row">
                <div class="col-md-8">
                    <div class="section-card">
                        <div class="section-header">
                            <h3>Menu Items</h3>
                            <button class="btn btn-sm btn-primary" onclick="addMenuItem()">
                                <i class="bi bi-plus"></i> Add Item
                            </button>
                        </div>
                        <div class="section-body">
                            <div id="menuItems">
                                {% if menu_items %}
                                    {% for item in menu_items %}
                                    <div class="menu-item-card" data-item-index="{{ loop.index0 }}">
                                        <div class="menu-item-handle">
                                            <i class="bi bi-grip-vertical"></i>
                                        </div>
                                        <div class="menu-item-content">
                                            <strong>{{ item.label }}</strong>
                                            <small class="text-muted">
                                                {% if item.link_type == 'page' %}
                                                    Page: {{ item.page_id }}
                                                {% else %}
                                                    URL: {{ item.custom_url }}
                                                {% endif %}
                                            </small>
                                        </div>
                                        <div class="menu-item-actions">
                                            <button class="btn btn-sm btn-outline-primary" onclick="editMenuItem({{ loop.index0 }})">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteMenuItem({{ loop.index0 }})">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="empty-state-small">
                                        <i class="bi bi-menu-button"></i>
                                        <p>No menu items yet. Click "Add Item" to create your first menu item.</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="section-card">
                        <div class="section-header">
                            <h3>Menu Settings</h3>
                        </div>
                        <div class="section-body">
                            <div class="mb-3">
                                <label class="form-label">Menu Name</label>
                                <input type="text" class="form-control" id="menuName" value="{{ menu.name }}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Position</label>
                                <select class="form-select" id="menuPosition">
                                    <option value="top" {% if menu.position == 'top' %}selected{% endif %}>Top</option>
                                    <option value="left" {% if menu.position == 'left' %}selected{% endif %}>Left</option>
                                    <option value="right" {% if menu.position == 'right' %}selected{% endif %}>Right</option>
                                </select>
                                <small class="text-muted">Where the menu appears on the page</small>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="menuActive" {% if menu.is_active %}checked{% endif %}>
                                    <label class="form-check-label" for="menuActive">
                                        Active (shown on site)
                                    </label>
                                </div>
                            </div>
                            <button class="btn btn-outline-primary w-100" onclick="editMenuStyles()">
                                <i class="bi bi-palette"></i> Menu Styling
                            </button>
                        </div>
                    </div>

                    <div class="section-card mt-3">
                        <div class="section-header">
                            <h3>Preview</h3>
                        </div>
                        <div class="section-body">
                            <div id="menuPreview" class="menu-preview">
                                <!-- Preview will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Menu Item Modal -->
<div class="modal fade" id="menuItemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Menu Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Label</label>
                    <input type="text" class="form-control" id="itemLabel">
                </div>
                <div class="mb-3">
                    <label class="form-label">Link Type</label>
                    <select class="form-select" id="itemLinkType" onchange="toggleLinkType()">
                        <option value="page">Page</option>
                        <option value="custom">Custom URL</option>
                    </select>
                </div>
                <div class="mb-3" id="pageSelectGroup">
                    <label class="form-label">Select Page</label>
                    <select class="form-select" id="itemPageId">
                        <option value="">-- Select a page --</option>
                        {% for page in pages %}
                        <option value="{{ page.id }}">{{ page.title }} ({{ page.slug }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3" id="customUrlGroup" style="display: none;">
                    <label class="form-label">Custom URL</label>
                    <input type="text" class="form-control" id="itemCustomUrl" placeholder="https://example.com">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveMenuItem()">Save</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
let menuItems = {{ menu_items|tojson }};
let currentEditingIndex = -1;
let menuItemModal = null;
let menuStyles = {{ menu.menu_styles|tojson if menu.menu_styles else '{}' }};
let styleModal = null;

document.addEventListener('DOMContentLoaded', function() {
    menuItemModal = new bootstrap.Modal(document.getElementById('menuItemModal'));
    styleModal = new bootstrap.Modal(document.getElementById('styleModal'));
    initializeSortable();
    updatePreview();
});

function initializeSortable() {
    const container = document.getElementById('menuItems');
    new Sortable(container, {
        animation: 150,
        handle: '.menu-item-handle',
        onEnd: function() {
            updateMenuItemsOrder();
        }
    });
}

function toggleLinkType() {
    const linkType = document.getElementById('itemLinkType').value;
    const pageGroup = document.getElementById('pageSelectGroup');
    const urlGroup = document.getElementById('customUrlGroup');

    if (linkType === 'page') {
        pageGroup.style.display = 'block';
        urlGroup.style.display = 'none';
    } else {
        pageGroup.style.display = 'none';
        urlGroup.style.display = 'block';
    }
}

function addMenuItem() {
    currentEditingIndex = -1;
    document.getElementById('itemLabel').value = '';
    document.getElementById('itemLinkType').value = 'page';
    document.getElementById('itemPageId').value = '';
    document.getElementById('itemCustomUrl').value = '';
    toggleLinkType();
    menuItemModal.show();
}

function editMenuItem(index) {
    currentEditingIndex = index;
    const item = menuItems[index];

    document.getElementById('itemLabel').value = item.label;
    document.getElementById('itemLinkType').value = item.link_type;
    document.getElementById('itemPageId').value = item.page_id || '';
    document.getElementById('itemCustomUrl').value = item.custom_url || '';
    toggleLinkType();
    menuItemModal.show();
}

function saveMenuItem() {
    const label = document.getElementById('itemLabel').value;
    const linkType = document.getElementById('itemLinkType').value;
    const pageId = document.getElementById('itemPageId').value;
    const customUrl = document.getElementById('itemCustomUrl').value;

    if (!label) {
        alert('Please enter a label');
        return;
    }

    if (linkType === 'page' && !pageId) {
        alert('Please select a page');
        return;
    }

    if (linkType === 'custom' && !customUrl) {
        alert('Please enter a custom URL');
        return;
    }

    const item = {
        label: label,
        link_type: linkType,
        page_id: linkType === 'page' ? parseInt(pageId) : null,
        custom_url: linkType === 'custom' ? customUrl : null
    };

    if (currentEditingIndex >= 0) {
        menuItems[currentEditingIndex] = item;
    } else {
        menuItems.push(item);
    }

    renderMenuItems();
    updatePreview();
    menuItemModal.hide();
}

function deleteMenuItem(index) {
    if (!confirm('Are you sure you want to delete this menu item?')) return;
    menuItems.splice(index, 1);
    renderMenuItems();
    updatePreview();
}

function updateMenuItemsOrder() {
    const cards = document.querySelectorAll('.menu-item-card');
    const newOrder = Array.from(cards).map(card => {
        const index = parseInt(card.dataset.itemIndex);
        return menuItems[index];
    });
    menuItems = newOrder;
    renderMenuItems();
    updatePreview();
}

function renderMenuItems() {
    const container = document.getElementById('menuItems');

    if (menuItems.length === 0) {
        container.innerHTML = `
            <div class="empty-state-small">
                <i class="bi bi-menu-button"></i>
                <p>No menu items yet. Click "Add Item" to create your first menu item.</p>
            </div>
        `;
        return;
    }

    container.innerHTML = menuItems.map((item, index) => {
        const linkInfo = item.link_type === 'page'
            ? `Page ID: ${item.page_id}`
            : `URL: ${item.custom_url}`;

        return `
            <div class="menu-item-card" data-item-index="${index}">
                <div class="menu-item-handle">
                    <i class="bi bi-grip-vertical"></i>
                </div>
                <div class="menu-item-content">
                    <strong>${item.label}</strong>
                    <small class="text-muted">${linkInfo}</small>
                </div>
                <div class="menu-item-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="editMenuItem(${index})">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteMenuItem(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function updatePreview() {
    const position = document.getElementById('menuPosition').value;
    const preview = document.getElementById('menuPreview');

    if (menuItems.length === 0) {
        preview.innerHTML = '<p class="text-muted">Add menu items to see preview</p>';
        return;
    }

    let previewHtml = '';

    if (position === 'top') {
        previewHtml = `
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">
                    <ul class="navbar-nav">
                        ${menuItems.map(item => `
                            <li class="nav-item">
                                <a class="nav-link" href="#">${item.label}</a>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            </nav>
        `;
    } else {
        previewHtml = `
            <div class="list-group">
                ${menuItems.map(item => `
                    <a href="#" class="list-group-item list-group-item-action">${item.label}</a>
                `).join('')}
            </div>
        `;
    }

    preview.innerHTML = previewHtml;
}

document.getElementById('menuPosition').addEventListener('change', updatePreview);

function editMenuStyles() {
    if (!menuStyles) menuStyles = {};

    const modalHtml = `
        <div class="modal fade" id="styleModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Menu Styling</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Background Color</label>
                                <input type="color" class="form-control form-control-color" id="menuBgColor" value="${menuStyles.backgroundColor || '#f8f9fa'}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Text Color</label>
                                <input type="color" class="form-control form-control-color" id="menuTextColor" value="${menuStyles.color || '#000000'}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Padding</label>
                                <input type="text" class="form-control" id="menuPadding" value="${menuStyles.padding || ''}" placeholder="e.g. 1rem">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Border</label>
                                <input type="text" class="form-control" id="menuBorder" value="${menuStyles.border || ''}" placeholder="e.g. 1px solid #dee2e6">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Custom CSS</label>
                            <textarea class="form-control" id="menuCustomCss" rows="4" placeholder="Additional CSS properties">${menuStyles.custom || ''}</textarea>
                            <small class="text-muted">Enter custom CSS properties like: font-size: 16px; font-weight: bold;</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveMenuStyles()">Save Styling</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove old modal if exists
    const oldModal = document.getElementById('styleModal');
    if (oldModal) oldModal.remove();

    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    styleModal = new bootstrap.Modal(document.getElementById('styleModal'));
    styleModal.show();
}

function saveMenuStyles() {
    menuStyles.backgroundColor = document.getElementById('menuBgColor').value;
    menuStyles.color = document.getElementById('menuTextColor').value;
    menuStyles.padding = document.getElementById('menuPadding').value;
    menuStyles.border = document.getElementById('menuBorder').value;
    menuStyles.custom = document.getElementById('menuCustomCss').value;

    styleModal.hide();
    alert('Styling saved. Click "Save Menu" to apply changes.');
}

function saveMenu() {
    const name = document.getElementById('menuName').value;
    const position = document.getElementById('menuPosition').value;
    const isActive = document.getElementById('menuActive').checked;

    if (!name) {
        alert('Please enter a menu name');
        return;
    }

    fetch('/menu/{{ menu.id }}/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            name: name,
            position: position,
            is_active: isActive,
            items: menuItems,
            menu_styles: menuStyles
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Menu saved successfully!');
            window.location.href = '/site/{{ site.id }}';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save menu');
    });
}
</script>
{% endblock %}
